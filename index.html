<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ZetGram v2 — Чат с Группами и ЛС</title>
<style>
  body,html {
    margin:0; padding:0; height:100%; font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #330000 0%, #110000 100%);
    color: #eee;
    display: flex; flex-direction: column;
    min-height: 100vh;
  }
  #app {
    flex: 1; display: flex; flex-direction: row; max-width: 1200px; margin: auto;
    border-radius: 10px; overflow: hidden; box-shadow: 0 0 30px rgba(255,0,0,0.7);
    background: #220000;
    min-height: 0;
  }
  #sidebar {
    width: 280px; background: #2a0a0a; display: flex; flex-direction: column; padding: 12px; box-sizing: border-box;
  }
  #sidebar h2 {
    margin-top: 0; margin-bottom: 12px; color: #ff4c4c; font-weight: 700; user-select:none;
  }
  #groupsList, #usersList {
    flex: 1; overflow-y: auto; margin-bottom: 16px;
    background: #3a1010; border-radius: 8px; padding: 8px; box-sizing: border-box;
  }
  .list-title {
    font-weight: 600; color: #f55; margin-bottom: 8px; user-select:none; font-size: 16px;
  }
  .item {
    padding: 8px; margin-bottom: 6px; background: #440000; border-radius: 6px; cursor: pointer;
    user-select:none; transition: background-color 0.2s; display: flex; align-items: center; gap: 8px;
  }
  .item:hover, .item.active {
    background: #b33;
  }
  .item .avatar {
    width: 36px; height: 36px; background: #660000; border-radius: 6px;
    font-weight: 700; color: #fff; display: flex; justify-content: center; align-items: center;
    font-size: 18px; flex-shrink: 0;
  }
  #chatPanel {
    flex: 1; display: flex; flex-direction: column; background: #330000;
    min-height: 0;
  }
  #chatHeader {
    padding: 14px 20px; background: #440000; font-weight: 700; font-size: 18px; color: #ff4c4c;
    user-select:none; display: flex; justify-content: space-between; align-items: center;
  }
  #chatMessages {
    flex: 1; overflow-y: auto; padding: 20px; box-sizing: border-box;
    display: flex; flex-direction: column; gap: 12px;
  }
  .message {
    max-width: 70%; background: #550000; padding: 12px 16px; border-radius: 12px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.4); word-break: break-word; position: relative;
    font-size: 15px;
  }
  .message.mine {
    background: linear-gradient(90deg, #ff2f2f, #8b0000); align-self: flex-end;
  }
  .message.console {
    background: #a00000; align-self: center; font-weight: 700; color: #fff; max-width: 90%; text-align: center;
  }
  .message .meta {
    font-size: 13px; margin-bottom: 6px; display: flex; align-items: center; gap: 8px;
  }
  .avatar-sm {
    width: 32px; height: 32px; background: #660000; border-radius: 6px;
    font-weight: 700; color: #fff; display: flex; justify-content: center; align-items: center;
    font-size: 14px; flex-shrink: 0;
  }
  #messageInputBar {
    display: flex; gap: 12px; padding: 14px 20px; background: #440000; box-sizing: border-box;
  }
  #messageInput {
    flex: 1; border-radius: 8px; border: none; padding: 10px 14px; font-size: 15px; resize: none;
    background: #550000; color: #eee; font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
  }
  #sendBtn {
    background: linear-gradient(90deg, #ff2f2f, #8b0000); border: none; border-radius: 8px;
    padding: 12px 24px; font-weight: 700; color: white; cursor: pointer; user-select:none;
    transition: background-color 0.3s;
  }
  #sendBtn:hover {
    background: #b30000;
  }
  #consoleToggleBtn {
    position: fixed; right: 20px; bottom: 80px; background: #b30000; color: #fff; border: none;
    border-radius: 50%; width: 50px; height: 50px; font-size: 26px; cursor: pointer; box-shadow: 0 0 15px #b30000;
    user-select:none; display: none; z-index: 9999;
  }
  #consolePanel {
    position: fixed; right: 20px; bottom: 140px; width: 350px; max-height: 450px; background: #2a0a0a;
    border-radius: 10px; padding: 12px 16px; box-sizing: border-box; box-shadow: 0 0 30px #b30000;
    color: #eee; display: none; flex-direction: column; z-index: 10000;
  }
  #consolePanel textarea {
    flex: 1; resize: none; border-radius: 8px; border: none; background: #440000; color: #eee;
    font-family: monospace; padding: 10px; font-size: 14px;
  }
  #consoleSendBtn {
    margin-top: 10px; background: #b30000; border: none; border-radius: 8px;
    color: white; font-weight: 700; cursor: pointer; padding: 10px; user-select:none;
  }
  /* Реклама внизу, не мешает */
  #adContainer {
    position: fixed;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 320px;
    max-width: 90vw;
    background: rgba(0, 0, 0, 0.45);
    border-radius: 12px 12px 0 0;
    box-shadow: 0 -3px 15px rgba(255,0,0,0.5);
    padding: 8px 0;
    z-index: 100000;
    text-align: center;
  }
  #adContainer iframe {
    width: 300px;
    height: 60px;
    border: none;
    border-radius: 8px;
    overflow: hidden;
  }
  @media(max-width: 768px){
    #app {flex-direction: column; max-width: 100%;}
    #sidebar {
      width: 100%; height: 140px; display: flex; flex-direction: row; overflow-x: auto; padding: 8px 12px;
    }
    #groupsList, #usersList {
      flex: none; margin-bottom: 0; margin-right: 12px; padding: 6px 8px;
      background: #3a1010; border-radius: 8px; height: 100%; display: flex; flex-direction: column; min-width: 120px;
    }
    #chatPanel {flex: 1; min-height: 0;}
    #chatMessages {padding: 12px 14px; font-size: 14px;}
    #messageInputBar {padding: 10px 14px;}
    #messageInput {font-size: 16px; padding: 8px 12px;}
    #sendBtn {padding: 10px 18px; font-size: 16px;}
    #adContainer iframe {
      width: 250px;
      height: 50px;
    }
  }
</style>
</head>
<body>

<div id="app" role="main" aria-label="ZetGram чат приложение">

  <aside id="sidebar" aria-label="Сайдбар с пользователями и группами">
    <h2>Группы</h2>
    <div id="groupsList" role="list" aria-label="Список групп">Загрузка групп...</div>

    <h2>Пользователи</h2>
    <div id="usersList" role="list" aria-label="Список пользователей">Загрузка пользователей...</div>
  </aside>

  <section id="chatPanel" aria-live="polite" aria-atomic="false" aria-relevant="additions">
    <header id="chatHeader" role="banner">
      <span id="chatTitle">Общий чат</span>
      <button id="logoutBtn" aria-label="Выйти из аккаунта">Выйти</button>
    </header>

    <main id="chatMessages" role="log" aria-live="polite" aria-relevant="additions"></main>

    <form id="messageForm" aria-label="Форма отправки сообщения" autocomplete="off">
      <div id="messageInputBar">
        <textarea id="messageInput" placeholder="Введите сообщение..." rows="2" required aria-required="true" aria-label="Текст сообщения"></textarea>
        <button id="sendBtn" type="submit" aria-label="Отправить сообщение">Отправить</button>
      </div>
    </form>
  </section>

</div>

<button id="consoleToggleBtn" title="Админская консоль" aria-haspopup="dialog" aria-controls="consolePanel">⚙️</button>

<div id="consolePanel" role="dialog" aria-modal="true" aria-labelledby="consoleTitle" tabindex="-1">
  <h3 id="consoleTitle" style="color:#ff4c4c; margin-top:0;">Админская консоль</h3>
  <textarea id="consoleInput" placeholder="Введите команду: /mute, /ban, /say..."></textarea>
  <button id="consoleSendBtn" aria-label="Отправить команду">Отправить</button>
</div>

<!-- Реклама, компактная, внизу -->
<div id="adContainer" aria-label="Реклама">
  <iframe 
    data-aa='2406373' 
    src='//acceptable.a-ads.com/2406373/?size=300x60&background_color=000000&title_color=b27&title_hover_color=fffefe' 
    scrolling="no" 
    aria-hidden="true"
    title="Реклама"
  ></iframe>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
  import { getDatabase, ref, push, onChildAdded, onValue, set, query, orderByChild, remove, onDisconnect } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

  // Твой firebaseConfig
  const firebaseConfig = {
    apiKey: "AIzaSyDTZrRKHrmKnA9ycBWvt9ephnr7TN6ZFs8",
    authDomain: "zetgram-d2b77.firebaseapp.com",
    databaseURL: "https://zetgram-d2b77-default-rtdb.firebaseio.com",
    projectId: "zetgram-d2b77",
    storageBucket: "zetgram-d2b77.firebasestorage.app",
    messagingSenderId: "804686454",
    appId: "1:804686454:web:db9f618955e3d370deed57",
    measurementId: "G-KCYSRCX4ZL"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  // UI
  const groupsListEl = document.getElementById("groupsList");
  const usersListEl = document.getElementById("usersList");
  const chatMessagesEl = document.getElementById("chatMessages");
  const chatTitleEl = document.getElementById("chatTitle");
  const logoutBtn = document.getElementById("logoutBtn");
  const messageForm = document.getElementById("messageForm");
  const messageInput = document.getElementById("messageInput");
  const sendBtn = document.getElementById("sendBtn");
  const consoleToggleBtn = document.getElementById("consoleToggleBtn");
  const consolePanel = document.getElementById("consolePanel");
  const consoleInput = document.getElementById("consoleInput");
  const consoleSendBtn = document.getElementById("consoleSendBtn");

  const ADMINS = new Set(["pechenka", "kalysmuhamedzanov@gmail.com"]);

  let currentUser = null;
  let activeChat = "general";
  let activeChatName = "Общий чат";

  let mutedUsers = {};
  let bannedUsers = new Set();

  let usersData = {};
  let groupsData = {};

  function el(tag, cls, txt){
    const e = document.createElement(tag);
    if(cls) e.className = cls;
    if(txt !== undefined) e.textContent = txt;
    return e;
  }
  function initials(name){
    if(!name) return "??";
    return name.trim().split(" ").map(w=>w[0].toUpperCase()).slice(0,2).join("");
  }
  function colorFromString(s){
    let hash = 0;
    for(let i=0; i<s.length; i++){
      hash = s.charCodeAt(i) + ((hash << 5) - hash);
      hash = hash & hash;
    }
    const h = Math.abs(hash) % 360;
    return `hsl(${h}, 70%, 40%)`;
  }
  function formatTime(ts){
    const d = new Date(ts);
    return d.toLocaleTimeString([], {hour: "2-digit", minute:"2-digit"});
  }
  function escapeHtml(text){
    if(!text) return "";
    return text.replace(/[&<>"']/g, m => {
      return {
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        '"': "&quot;",
        "'": "&#39;"
      }[m];
    });
  }

  function renderGroups(){
    groupsListEl.innerHTML = "";
    for(let id in groupsData){
      const group = groupsData[id];
      const div = el("div","item", group.name);
      div.dataset.id = id;
      if(activeChat === id) div.classList.add("active");
      div.onclick = () => openChat(id, group.name, true);
      groupsListEl.appendChild(div);
    }
    if(Object.keys(groupsData).length === 0){
      groupsListEl.textContent = "Нет групп";
    }
  }

  function renderUsers(){
    usersListEl.innerHTML = "";
    for(let uid in usersData){
      if(uid === currentUser.uid) continue;
      if(bannedUsers.has(uid)) continue;
      const u = usersData[uid];
      const div = el("div","item");
      div.dataset.uid = uid;
      div.onclick = () => openChat(uid, u.username || u.email, false);
      const av = el("div","avatar", initials(u.username || u.email));
      av.style.background = colorFromString(u.username || u.email);
      div.appendChild(av);
      const nameSpan = el("span", "", u.username || u.email);
      div.appendChild(nameSpan);
      usersListEl.appendChild(div);
    }
    if(usersListEl.childElementCount === 0){
      usersListEl.textContent = "Нет пользователей";
    }
  }

  let messagesListener = null;

  async function openChat(id, name, isGroup = false){
    activeChat = id;
    activeChatName = name;
    chatTitleEl.textContent = (isGroup) ? `Группа: ${name}` : (id === "general" ? "Общий чат" : `ЛС: ${name}`);
    chatMessagesEl.innerHTML = "";
    if(messagesListener) messagesListener();
    messagesListener = null;
    const messagesRef = ref(db, chatPath(id));
    const q = query(messagesRef, orderByChild('timestamp'));
    messagesListener = onChildAdded(q, snapshot => {
      const msg = snapshot.val();
      if(!msg) return;
      if(isUserBanned(msg.uid)) return;
      if(isUserMuted(msg.uid)) return;
      renderMessage(msg);
      chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
    });
  }

  function chatPath(id){
    if(id === "general") return "chats/general";
    if(groupsData[id]) return `chats/groups/${id}`;
    let arr = [currentUser.uid, id].sort();
    return `chats/private/${arr[0]}_${arr[1]}`;
  }

  function renderMessage(msg){
    const mine = (msg.uid === currentUser.uid);
    const div = el("div","message");
    if(mine) div.classList.add("mine");
    if(msg.fromConsole) div.classList.add("console");

    const meta = el("div","meta");
    const avatar = el("div","avatar-sm");
    avatar.style.background = colorFromString(msg.username || msg.uid);
    avatar.textContent = initials(msg.username || msg.uid);
    meta.appendChild(avatar);
    const nameSpan = el("span");
    nameSpan.textContent = msg.username || msg.uid;
    meta.appendChild(nameSpan);
    const timeSpan = el("time");
    timeSpan.textContent = formatTime(msg.timestamp);
    timeSpan.setAttribute("datetime", new Date(msg.timestamp).toISOString());
    meta.appendChild(timeSpan);

    div.appendChild(meta);

    const textDiv = el("div", "text");
    textDiv.innerHTML = escapeHtml(msg.text).replace(/\n/g, "<br>");
    div.appendChild(textDiv);

    chatMessagesEl.appendChild(div);
  }

  function isUserMuted(uid){
    if(!mutedUsers[uid]) return false;
    return Date.now() < mutedUsers[uid];
  }
  function isUserBanned(uid){
    return bannedUsers.has(uid);
  }

  async function sendMessage(text){
    if(!text.trim()) return;
    if(isUserMuted(currentUser.uid)){
      alert("Вы замучены и не можете отправлять сообщения.");
      return;
    }
    const msgObj = {
      uid: currentUser.uid,
      username: currentUser.displayName || currentUser.email.split("@")[0],
      text: text.trim(),
      timestamp: Date.now(),
      fromConsole: false,
    };
    const newRef = push(ref(db, chatPath(activeChat)));
    msgObj.key = newRef.key;
    await set(newRef, msgObj);
    messageInput.value = "";
  }

  async function handleCommand(text){
    const parts = text.trim().split(" ");
    const cmd = parts[0].toLowerCase();
    const args = parts.slice(1);

    if(cmd === "/mute"){
      if(args.length < 2){
        sendConsoleMessage("Использование: /mute <ник> <минуты>");
        return;
      }
      const nick = args[0];
      const timeMin = parseInt(args[1]);
      if(isNaN(timeMin) || timeMin <= 0){
        sendConsoleMessage("Неверное время мута");
        return;
      }
      const user = findUserByNick(nick);
      if(!user){
        sendConsoleMessage(`Пользователь "${nick}" не найден`);
        return;
      }
      mutedUsers[user.uid] = Date.now() + timeMin * 60000;
      sendConsoleMessage(`Пользователь "${nick}" замучен на ${timeMin} минут.`);
    } else if(cmd === "/ban"){
      if(args.length < 1){
        sendConsoleMessage("Использование: /ban <ник>");
        return;
      }
      const nick = args[0];
      const user = findUserByNick(nick);
      if(!user){
        sendConsoleMessage(`Пользователь "${nick}" не найден`);
        return;
      }
      bannedUsers.add(user.uid);
      sendConsoleMessage(`Пользователь "${nick}" забанен.`);
      await remove(ref(db, "users/" + user.uid));
    } else if(cmd === "/say"){
      if(args.length < 1){
        sendConsoleMessage("Использование: /say <сообщение>");
        return;
      }
      const sayText = args.join(" ");
      const msgObj = {
        uid: "console",
        username: "[console]",
        text: sayText,
        timestamp: Date.now(),
        fromConsole: true,
      };
      const newRef = push(ref(db, "chats/general"));
      msgObj.key = newRef.key;
      await set(newRef, msgObj);
    } else {
      sendConsoleMessage(`Неизвестная команда: ${cmd}`);
    }
  }

  async function sendConsoleMessage(text){
    const msgObj = {
      uid: "console",
      username: "[console]",
      text,
      timestamp: Date.now(),
      fromConsole: true,
    };
    const newRef = push(ref(db, "chats/general"));
    msgObj.key = newRef.key;
    await set(newRef, msgObj);
  }

  function findUserByNick(nick){
    nick = nick.toLowerCase();
    for(let uid in usersData){
      const user = usersData[uid];
      if(user.username && user.username.toLowerCase() === nick) return {uid, ...user};
    }
    return null;
  }

  function isAdmin(){
    if(!currentUser) return false;
    const nick = (currentUser.displayName || currentUser.email.split("@")[0]).toLowerCase();
    if(ADMINS.has(nick) || ADMINS.has(currentUser.email.toLowerCase())) return true;
    return false;
  }

  function listenUsers(){
    const usersRef = ref(db, "users");
    onValue(usersRef, snapshot => {
      usersData = snapshot.val() || {};
      renderUsers();
    });
  }

  function listenGroups(){
    const groupsRef = ref(db, "groups");
    onValue(groupsRef, snapshot => {
      groupsData = snapshot.val() || {};
      renderGroups();
    });
  }

  async function updateCurrentUserOnline(){
    if(!currentUser) return;
    const userRef = ref(db, "users/" + currentUser.uid);
    await set(userRef, {
      username: currentUser.displayName || currentUser.email.split("@")[0],
      email: currentUser.email,
      online: true,
      lastSeen: Date.now()
    });
    onDisconnect(userRef).remove();
  }

  logoutBtn.onclick = () => {
    signOut(auth);
  };

  messageForm.onsubmit = e => {
    e.preventDefault();
    sendMessage(messageInput.value);
  };

  consoleToggleBtn.onclick = () => {
    if(consolePanel.style.display === "flex"){
      consolePanel.style.display = "none";
    } else {
      consolePanel.style.display = "flex";
      consoleInput.focus();
    }
  };

  consoleSendBtn.onclick = async () => {
    if(!consoleInput.value.trim()) return;
    await handleCommand(consoleInput.value.trim());
    consoleInput.value = "";
  };

  async function loginFlow(){
    while(true){
      let email = prompt("Введите email:");
      if(!email){
        alert("Вход отменён");
        return false;
      }
      let pass = prompt("Введите пароль:");
      if(!pass){
        alert("Вход отменён");
        return false;
      }
      try {
        await signInWithEmailAndPassword(auth, email, pass);
        return true;
      } catch(e){
        if(e.code === "auth/user-not-found"){
          // Регистрация
          try {
            await createUserWithEmailAndPassword(auth, email, pass);
            let nick = prompt("Регистрация успешна! Введите ник:");
            if(nick && auth.currentUser){
              await updateProfile(auth.currentUser, {displayName: nick});
            }
            return true;
          } catch(e2){
            alert("Ошибка регистрации: " + e2.message);
          }
        } else {
          alert("Ошибка входа: " + e.message);
        }
      }
    }
  }

  onAuthStateChanged(auth, async user => {
    if(user){
      currentUser = user;
      await updateCurrentUserOnline();
      listenUsers();
      listenGroups();

      if(isAdmin()){
        consoleToggleBtn.style.display = "block";
      } else {
        consoleToggleBtn.style.display = "none";
        consolePanel.style.display = "none";
      }

      await openChat("general", "Общий чат", false);

    } else {
      currentUser = null;
      usersListEl.innerHTML = "";
      groupsListEl.innerHTML = "";
      chatMessagesEl.innerHTML = "";
      chatTitleEl.textContent = "Пожалуйста, войдите";
      consoleToggleBtn.style.display = "none";
      consolePanel.style.display = "none";

      await loginFlow();
    }
  });
</script>

</body>
</html>
