<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1, maximum-scale=1" />
<title>ZetGram ‚Äî Chat</title>

<style>
:root{
  --bg:#1a0000; --panel:#2a0f0f; --accent:#b30000; --accent-2:#ff4c4c; --muted:#ff9999;
  --glass: rgba(255,255,255,0.03);
  --nice: #ffefef;
}
*{box-sizing:border-box}
html,body{height:100%; margin:0; font-family: Inter,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--nice); -webkit-font-smoothing:antialiased}
.app{
  height:100vh; display:flex; flex-direction:column;
}
/* header */
.header{
  display:flex; align-items:center; justify-content:space-between;
  padding:12px 16px; background:linear-gradient(90deg,var(--accent),#7e0000);
  box-shadow: 0 3px 10px rgba(0,0,0,0.5);
  user-select:none;
}
.header .title{font-weight:700; font-size:18px; cursor:default;}
.header .user-info{display:flex; gap:10px; align-items:center; cursor:pointer;}
.header .user-info.selected {
  outline: 2px solid var(--accent-2);
  border-radius: 8px;
}

/* layout */
.container{
  flex:1; display:flex; gap:12px; padding:12px;
  overflow: hidden;
}
/* sidebar users */
.sidebar{
  width:220px; max-width:30%;
  background:var(--panel); border-radius:12px; padding:12px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.4);
  display:flex; flex-direction:column;
  overflow-y: auto;
  user-select:none;
  scrollbar-width: thin;
  scrollbar-color: var(--accent-2) transparent;
}
.sidebar::-webkit-scrollbar {
  width: 6px;
}
.sidebar::-webkit-scrollbar-thumb {
  background-color: var(--accent-2);
  border-radius: 10px;
}
.sidebar h3{margin:0 0 10px 0; color:var(--accent-2); user-select:none;}
.users-list{flex:1; display:flex; flex-direction:column; gap:8px; padding-right:6px;}
.user-row{
  display:flex; gap:8px; align-items:center; padding:8px; border-radius:8px; cursor:pointer;
  transition: background-color 0.2s ease;
}
.user-row.selected, .user-row:hover{
  background: var(--accent-2);
  color: #fff;
}
.user-row .avatar{
  width:40px;height:40px;border-radius:8px; display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff;
  flex-shrink: 0;
}
.user-row .meta{
  display:flex;flex-direction:column; user-select:none;
}
.user-row .meta .name{font-weight:600;}
.user-row .status{font-size:12px; color:var(--muted);}

/* main chat panel */
.panel{
  flex:1; display:flex; flex-direction:column; border-radius:12px; background: linear-gradient(180deg,#240606,#2a0f0f);
  padding:10px; box-shadow: 0 8px 30px rgba(0,0,0,0.6);
  min-width:320px;
  overflow: hidden;
}

/* message area */
.messages{
  flex:1; overflow-y:auto; padding:12px; display:flex; flex-direction:column; gap:10px;
  scroll-behavior:smooth;
  user-select:none;
  scrollbar-width: thin;
  scrollbar-color: var(--accent-2) transparent;
}
.messages::-webkit-scrollbar {
  width: 8px;
}
.messages::-webkit-scrollbar-thumb {
  background-color: var(--accent-2);
  border-radius: 10px;
}
.message{
  max-width:72%; padding:10px 12px; border-radius:12px; position:relative;
  box-shadow: 0 4px 12px rgba(0,0,0,0.4);
  word-break:break-word; background: #4a0a0a;
  user-select:text;
}
.message.mine{align-self:flex-end; background: linear-gradient(180deg,var(--accent),#8b0000);}
.message.ls {
  border: 2px solid var(--accent-2);
  background: #6b0000;
}
.message .meta{display:flex; gap:8px; align-items:center; margin-bottom:6px;}
.avatar-sm{
  width:36px;height:36px;border-radius:8px;display:inline-flex;align-items:center;justify-content:center;font-weight:700;color:white;
  flex-shrink: 0;
}
.author{font-weight:700; color:var(--accent-2);}
.time{font-size:12px;color:var(--muted); margin-left:6px;}
.msg-text{font-size:15px; margin-bottom:6px;}
.msg-img{display:block; max-width:320px; border-radius:8px; margin-top:6px; box-shadow: 0 6px 16px rgba(0,0,0,0.5);}

/* delete button */
.del-btn{
  position:absolute; top:6px; right:6px; background:transparent; border:none; color:var(--muted); font-weight:700; cursor:pointer;
  font-size:18px; line-height:14px;
}

/* input area fixed bottom inside panel */
.input-bar{
  display:flex; gap:8px; align-items:center; margin-top:8px; padding-top:8px; border-top:1px solid rgba(255,0,0,0.06);
}
.input-field{
  flex:1; display:flex; gap:8px; align-items:center; background:var(--glass); padding:8px; border-radius:10px;
}
textarea{
  flex:1; resize:none; padding:8px; border-radius:8px; background:transparent; border:none; color:var(--nice); outline:none; font-size:15px;
  min-height: 44px;
}
.file-btn{
  background:transparent; border:2px dashed rgba(255,255,255,0.06); padding:6px;border-radius:8px; color:var(--muted); cursor:pointer;
  flex-shrink: 0;
}
.send-btn{
  background:linear-gradient(90deg,var(--accent),#ff3b3b); border:none; color:white; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:700;
  flex-shrink: 0;
}

/* LS info */
.ls-info {
  margin: 6px 0 12px 0;
  font-size: 14px;
  color: var(--accent-2);
  user-select:none;
  font-weight: 600;
}

/* responsive */
@media(max-width:880px){
  .container{padding:8px; flex-direction: column;}
  .sidebar{display:flex; width: 100%; max-width: 100%; height: 150px; overflow-x:auto; overflow-y:hidden; padding:8px;}
  .users-list{
    flex-direction: row;
    gap: 12px;
    padding-right: 0;
  }
  .user-row{
    flex-direction: column;
    align-items: center;
    padding: 6px 8px;
    min-width: 80px;
    border-radius: 12px;
  }
  .user-row .avatar{
    width: 48px; height: 48px; border-radius: 12px; font-size: 18px;
  }
  .user-row .meta{
    display:none;
  }
  .panel{min-width:0; flex:1;}
  .input-bar{
    flex-wrap: wrap;
  }
  textarea {
    min-height: 60px;
  }
}

/* Scroll wheel only scroll messages, not sidebar */
.sidebar {
  overscroll-behavior: contain;
}
</style>
</head>
<body>
<div class="app" role="application" aria-label="ZetGram chat">
  <div class="header" role="banner">
    <div class="title">ZetGram üî¥</div>
    <div class="user-info" id="headerUser" title="–î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ ‚Äî –≤—ã–π—Ç–∏"></div>
  </div>

  <div class="container">
    <div class="sidebar" aria-label="–°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π">
      <h3>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h3>
      <div class="users-list" id="usersList"></div>
      <div style="margin-top:8px; text-align:center; color:var(--muted); font-size:13px">–û–Ω–ª–∞–π–Ω / –í —Å–µ—Ç–∏</div>
    </div>

    <div class="panel" role="main">
      <div class="ls-info" id="lsInfo">–û–±—â–∏–π —á–∞—Ç</div>
      <div class="messages" id="messages" aria-live="polite"></div>

      <div class="input-bar" role="region" aria-label="–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è">
        <div class="input-field">
          <textarea id="textInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (Enter ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å, Shift+Enter ‚Äî –Ω–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞)"></textarea>
          <input id="fileInput" class="file-btn" type="file" accept="image/*" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ" />
        </div>
        <button class="send-btn" id="sendBtn" aria-label="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>
    </div>
  </div>
</div>

<!-- Firebase SDK (modular) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import {
    getAuth,
    signInWithEmailAndPassword,
    createUserWithEmailAndPassword,
    onAuthStateChanged,
    signOut,
    updateProfile
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
  import {
    getDatabase,
    ref,
    push,
    onChildAdded,
    onChildRemoved,
    query,
    orderByChild,
    set,
    onValue,
    remove,
    onDisconnect
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";
  import {
    getStorage,
    ref as storageRef,
    uploadBytes,
    getDownloadURL
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-storage.js";

  // ---------- CONFIG ----------
  const firebaseConfig = {
    apiKey: "AIzaSyDTZrRKHrmKnA9ycBWvt9ephnr7TN6ZFs8",
    authDomain: "zetgram-d2b77.firebaseapp.com",
    databaseURL: "https://zetgram-d2b77-default-rtdb.firebaseio.com",
    projectId: "zetgram-d2b77",
    storageBucket: "zetgram-d2b77.appspot.com",
    messagingSenderId: "804686454",
    appId: "1:804686454:web:db9f618955e3d370deed57",
    measurementId: "G-KCYSRCX4ZL"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);
  const storage = getStorage(app);

  // ---------- UI refs ----------
  const messagesEl = document.getElementById('messages');
  const textInput = document.getElementById('textInput');
  const fileInput = document.getElementById('fileInput');
  const sendBtn = document.getElementById('sendBtn');
  const usersListEl = document.getElementById('usersList');
  const headerUser = document.getElementById('headerUser');
  const lsInfo = document.getElementById('lsInfo');

  // ---------- Helpers ----------
  function el(tag, cls, txt){
    const e = document.createElement(tag);
    if(cls) e.className = cls;
    if(txt !== undefined) e.textContent = txt;
    return e;
  }
  function timeString(ts){
    const d = new Date(ts);
    return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
  }
  function initials(name){
    if(!name) return '??';
    return name.split(' ').map(s=>s[0]?.toUpperCase()||'').slice(0,2).join('');
  }
  function colorFromString(s){
    let h=0; for(let i=0;i<s.length;i++) h = (h<<5)-h + s.charCodeAt(i);
    const hue = Math.abs(h)%360;
    return `hsl(${hue} 80% 35%)`;
  }

  // ---------- Presence & users ----------
  const displayedUsers = new Map(); // uid->node
  let selectedUserUid = null; // –¥–ª—è –õ–°

  function renderUser(uid, data){
    let row = displayedUsers.get(uid);
    if(!row){
      row = el('div','user-row');
      const av = el('div','avatar');
      av.textContent = initials(data.username||uid);
      av.style.background = colorFromString(data.username||uid);
      const meta = el('div','meta');
      const name = el('div','name', data.username||'–ë–µ–∑ –∏–º–µ–Ω–∏');
      const status = el('div','status', data.online ? '–æ–Ω–ª–∞–π–Ω' : `–ø–æ—Å–ª–µ–¥–Ω–∏–π: ${data.lastSeen ? new Date(data.lastSeen).toLocaleString() : '‚Äî'}`);
      status.style.color='var(--muted)';
      meta.appendChild(name);
      meta.appendChild(status);
      row.appendChild(av);
      row.appendChild(meta);
      usersListEl.appendChild(row);

      // –ö–ª–∏–∫ ‚Äî –≤—ã–±—Ä–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –õ–° (–µ—Å–ª–∏ –∫–ª–∏–∫ –Ω–∞ —Å–∞–º–æ–≥–æ —Å–µ–±—è ‚Äî –æ—Ç–º–µ–Ω–∞ –≤—ã–±–æ—Ä–∞)
      row.addEventListener('click', () => {
        if(auth.currentUser && uid === auth.currentUser.uid){
          selectedUserUid = null;
        } else {
          selectedUserUid = (selectedUserUid === uid) ? null : uid;
        }
        updateUserSelection();
        renderMessagesAll(); // –æ–±–Ω–æ–≤–∏—Ç—å —á–∞—Ç –ø—Ä–∏ —Å–º–µ–Ω–µ –õ–°
      });

      displayedUsers.set(uid,row);
    } else {
      // update status and name
      const name = row.querySelector('.meta .name');
      const status = row.querySelector('.meta .status');
      if(name) name.textContent = data.username||'–ë–µ–∑ –∏–º–µ–Ω–∏';
      if(status) status.textContent = data.online ? '–æ–Ω–ª–∞–π–Ω' : `–ø–æ—Å–ª–µ–¥–Ω–∏–π: ${data.lastSeen ? new Date(data.lastSeen).toLocaleString() : '‚Äî'}`;
    }
    updateUserSelection();
  }

  function updateUserSelection(){
    for(const [uid,node] of displayedUsers){
      if(uid === selectedUserUid){
        node.classList.add('selected');
      } else {
        node.classList.remove('selected');
      }
    }
    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —à–∞–ø–∫–µ, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
  }

  // listen users list
  const usersRef = ref(db, 'users');
  onValue(usersRef, snapshot=>{
    const v = snapshot.val() || {};
    const uids = Object.keys(v);
    uids.forEach(uid => {
      renderUser(uid, v[uid]);
    });
    // remove old
    for(const [uid,node] of displayedUsers){
      if(!v[uid]) { node.remove(); displayedUsers.delete(uid); }
    }
  });

  // ---------- messages ----------
  const displayedMessages = new Set();

  // –ë—É–¥–µ–º —Ö—Ä–∞–Ω–∏—Ç—å –≤ –ø–∞–º—è—Ç–∏ –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è, —á—Ç–æ–±—ã —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –ø—Ä–∏ —Å–º–µ–Ω–µ –õ–°
  let allMessages = new Map();

  function scrollToBottom(){
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –æ–¥–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è (—Å —É—á—ë—Ç–æ–º —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –õ–°)
  function renderMessage(key, msg){
    // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –õ–°:
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º, –µ—Å–ª–∏
    // 1) –°–æ–æ–±—â–µ–Ω–∏–µ –≥–ª–æ–±–∞–ª—å–Ω–æ–µ (msg.toUid == null/undefined)
    // 2) –°–æ–æ–±—â–µ–Ω–∏–µ –õ–°, –∏ —Ç—ã ‚Äî –∞–≤—Ç–æ—Ä –∏–ª–∏ –ø–æ–ª—É—á–∞—Ç–µ–ª—å
    if(selectedUserUid){
      // –õ–° –≤—ã–±—Ä–∞–Ω
      const mine = auth.currentUser?.uid;
      const toUid = msg.toUid || null;
      if(toUid !== selectedUserUid && toUid !== mine){
        return; // –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ
      }
      // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –õ–° –º–µ–∂–¥—É mine –∏ selectedUserUid
    } else {
      // –ù–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ
      if(msg.toUid){
        return;
      }
    }

    if(displayedMessages.has(key)) return;
    displayedMessages.add(key);

    const isMine = auth.currentUser && msg.uid === auth.currentUser.uid;
    const wrapper = el('div','message ' + (isMine ? 'mine':'other'));
    wrapper.id = 'm-'+key;

    if(msg.toUid) wrapper.classList.add('ls');

    // meta (avatar + author + time)
    const meta = el('div','meta');
    const av = el('div','avatar-sm');
    av.style.background = colorFromString(msg.author || msg.username || msg.uid);
    av.textContent = initials(msg.author || msg.username || msg.uid);
    const author = el('div','author', msg.author || msg.username || '–ë–µ–∑ –∏–º–µ–Ω–∏');
    const tm = el('div','time', timeString(msg.timestamp||Date.now()));

    meta.appendChild(av);
    meta.appendChild(author);
    meta.appendChild(tm);

    const textNode = el('div','msg-text', msg.text || '');

    wrapper.appendChild(meta);
    if(msg.text) wrapper.appendChild(textNode);

    // image (if present)
    if(msg.imageUrl){
      const img = document.createElement('img');
      img.src = msg.imageUrl;
      img.className = 'msg-img';
      img.alt = '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ';
      wrapper.appendChild(img);
      img.addEventListener('load', scrollToBottom);
    }

    // delete button for own
    if(isMine){
      const delBtn = el('button','del-btn','√ó');
      delBtn.title = "–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ";
      delBtn.addEventListener('click', async e => {
        e.stopPropagation();
        if(confirm("–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?")) {
          try {
            await remove(ref(db, 'messages/' + key));
            displayedMessages.delete(key);
            const el = document.getElementById('m-'+key);
            if(el) el.remove();
          } catch(e) {
            alert("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: "+e.message);
          }
        }
      });
      wrapper.appendChild(delBtn);
    }

    messagesEl.appendChild(wrapper);
    scrollToBottom();
  }

  // –û—á–∏—Å—Ç–∏—Ç—å –∏ –æ—Ç—Ä–∏—Å–æ–≤–∞—Ç—å –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∑–∞–Ω–æ–≤–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏ —Å–º–µ–Ω–µ –õ–°)
  function renderMessagesAll(){
    messagesEl.innerHTML = '';
    displayedMessages.clear();
    allMessages.forEach((msg,key) => {
      renderMessage(key, msg);
    });
  }

  // listen messages
  const messagesRef = ref(db, 'messages');
  onChildAdded(messagesRef, snapshot=>{
    const key = snapshot.key;
    const msg = snapshot.val();
    allMessages.set(key, msg);
    renderMessage(key, msg);
  });
  onChildRemoved(messagesRef, snapshot=>{
    const key = snapshot.key;
    allMessages.delete(key);
    displayedMessages.delete(key);
    const el = document.getElementById('m-'+key);
    if(el) el.remove();
  });

  // ---------- sending message ----------
  sendBtn.onclick = sendMessage;
  textInput.addEventListener('keydown', e=>{
    if(e.key === 'Enter' && !e.shiftKey){
      e.preventDefault();
      sendMessage();
    }
  });

  async function sendMessage(){
    if(!auth.currentUser) {
      alert("–°–Ω–∞—á–∞–ª–∞ –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å!");
      return;
    }
    const text = textInput.value.trim();
    if(!text && !fileInput.files.length){
      alert("–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª");
      return;
    }

    sendBtn.disabled = true;

    let imageUrl = null;
    if(fileInput.files.length){
      const file = fileInput.files[0];
      try {
        const storageReference = storageRef(storage, 'chat_images/' + Date.now() + '_' + file.name);
        const snapshot = await uploadBytes(storageReference, file);
        imageUrl = await getDownloadURL(snapshot.ref);
      } catch(e){
        alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞: "+e.message);
        sendBtn.disabled = false;
        return;
      }
    }

    const newMsg = {
      uid: auth.currentUser.uid,
      author: auth.currentUser.displayName || auth.currentUser.email || '–ë–µ–∑ –∏–º–µ–Ω–∏',
      timestamp: Date.now(),
      text: text || '',
      imageUrl: imageUrl || null,
      toUid: selectedUserUid || null // null ‚Äî –æ–±—â–∏–π —á–∞—Ç
    };
    try {
      await push(ref(db, 'messages'), newMsg);
      textInput.value = '';
      fileInput.value = '';
      sendBtn.disabled = false;
      scrollToBottom();
    } catch(e) {
      alert("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: "+e.message);
      sendBtn.disabled = false;
    }
  }

  // ---------- auth (–∞–Ω–æ–Ω–∏–º–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã) ----------
  // –¢.–∫. –≤ —Ç–≤–æ—ë–º –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ–º –∫–æ–¥–µ —ç—Ç–æ–≥–æ –Ω–µ –±—ã–ª–æ, —Å–¥–µ–ª–∞–µ–º –ø—Ä–æ—Å—Ç–æ–π –≤—Ö–æ–¥ —Å prompt –∏ –ª–æ–∫–∞–ª—å–Ω–æ–π —Å–µ—Å—Å–∏–µ–π

  async function signInPrompt(){
    let email = localStorage.getItem('email');
    if(!email){
      email = prompt("–í–≤–µ–¥–∏—Ç–µ –≤–∞—à email (–Ω–∞–ø—Ä–∏–º–µ—Ä test@example.com):");
      if(!email) return;
      localStorage.setItem('email', email);
    }
    let password = localStorage.getItem('password');
    if(!password){
      password = prompt("–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å (–Ω–∞–ø—Ä–∏–º–µ—Ä 123456):");
      if(!password) return;
      localStorage.setItem('password', password);
    }
    try {
      await signInWithEmailAndPassword(auth, email, password);
    } catch(e){
      if(e.code === 'auth/user-not-found'){
        // —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        try {
          await createUserWithEmailAndPassword(auth, email, password);
          alert("–°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å " + email);
        } catch(e2){
          alert("–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: "+e2.message);
        }
      } else {
        alert("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: "+e.message);
      }
    }
  }

  // –æ–±–Ω–æ–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –≤ –ë–î
  function updateUserData(user){
    if(!user) return;
    const uref = ref(db, 'users/' + user.uid);
    set(uref, {
      username: user.displayName || user.email || user.uid,
      online: true,
      lastSeen: Date.now()
    });
    // —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å offline –ø—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏
    onDisconnect(uref).update({online: false, lastSeen: Date.now()});
  }

  // –æ—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ
  function clearUserData(user){
    if(!user) return;
    const uref = ref(db, 'users/' + user.uid);
    set(uref, {
      username: user.displayName || user.email || user.uid,
      online: false,
      lastSeen: Date.now()
    });
  }

  // –æ–±–Ω–æ–≤–ª—è–µ–º UI –≤ —à–∞–ø–∫–µ
  function updateHeaderUser(user){
    if(!user) {
      headerUser.textContent = "–ì–æ—Å—Ç—å (–Ω–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –≤–æ–π—Ç–∏)";
      headerUser.classList.remove('selected');
      return;
    }
    headerUser.textContent = user.displayName || user.email || user.uid;
    headerUser.classList.add('selected');
  }

  headerUser.addEventListener('dblclick', async () => {
    if(auth.currentUser){
      clearUserData(auth.currentUser);
      await signOut(auth);
      selectedUserUid = null;
      updateUserSelection();
      renderMessagesAll();
    }
  });

  headerUser.addEventListener('click', () => {
    if(!auth.currentUser){
      signInPrompt();
    }
  });

  onAuthStateChanged(auth, user => {
    if(user){
      updateUserData(user);
      updateHeaderUser(user);
    } else {
      updateHeaderUser(null);
    }
  });

  // ---------- scroll wheel fix ----------
  // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –º—ã—à—å—é –Ω–∞ —Å–ø–∏—Å–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–µ —Å–∫—Ä–æ–ª–ª–∏—Ç —á–∞—Ç (–ø–µ—Ä–µ—Ö–≤–∞—Ç —Å–æ–±—ã—Ç–∏—è)
  document.querySelector('.sidebar').addEventListener('wheel', e => {
    // –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å–∫—Ä–æ–ª–ª –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –≤ —Å—Ç–æ—Ä–æ–Ω—É, –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ sidebar
    e.stopPropagation();
  }, {passive: false});

  // ---------- initial ----------
  // –ù–µ–º–Ω–æ–≥–æ —Å—Ç–∞—Ä—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ users (–¥–ª—è —Ç–µ—Å—Ç–∞)
  // –í Firebase Realtime Database –ø–æ–¥ users —Ö—Ä–∞–Ω—è—Ç—Å—è:
  // uid: { username, online, lastSeen }

</script>
</body>
<div id="frame" style="
  width: 320px;
  max-width: 90%;
  margin: 8px auto;
  background: rgba(0, 0, 0, 0.5);
  position: relative;
  z-index: 99998;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 0 8px rgba(0,0,0,0.4);
">
  <iframe data-aa="2406373" src="//acceptable.a-ads.com/2406373/?size=320x50&background_color=ddd&title_color=b27&title_hover_color=fffefe"
    style="border:0; width:100%; height:50px; display:block;"
    scrolling="no" 
    allowtransparency="true" 
    frameborder="0" 
    marginwidth="0" 
    marginheight="0">
  </iframe>
</div>

</html>
