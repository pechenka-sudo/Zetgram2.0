<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ZetGram —Å –∞–¥–º–∏–Ω –∫–æ–Ω—Å–æ–ª—å—é</title>

<style>
  :root {
    --bg: #1a0000;
    --panel: #2a0f0f;
    --accent: #b30000;
    --accent-2: #ff4c4c;
    --muted: #ff9999;
    --nice: #ffefef;
    --glass: rgba(255,255,255,0.03);
  }
  * { box-sizing: border-box; }
  body, html {
    margin: 0; padding: 0; height: 100%; font-family: Inter,Segoe UI,Roboto,Arial,sans-serif;
    background: var(--bg); color: var(--nice);
  }
  #app {
    display: flex; flex-direction: column; height: 100vh;
  }
  header {
    background: linear-gradient(90deg, var(--accent), #7e0000);
    padding: 12px 16px;
    display: flex; justify-content: space-between; align-items: center;
    box-shadow: 0 3px 10px rgba(0,0,0,0.5);
  }
  header .title {
    font-weight: 700; font-size: 20px;
  }
  header .user-info {
    display: flex; align-items: center; gap: 15px; color: var(--nice);
  }
  header .user-info button {
    background: var(--accent);
    border: none;
    color: white;
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
  }
  
  main {
    flex: 1;
    display: flex;
    overflow: hidden;
  }

  /* Sidebar: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏ –≥—Ä—É–ø–ø—ã */
  #sidebar {
    width: 250px;
    background: var(--panel);
    padding: 10px;
    display: flex;
    flex-direction: column;
  }
  #sidebar h2 {
    margin-top: 0; margin-bottom: 8px;
    color: var(--accent-2);
  }
  .list-section {
    flex: 1;
    overflow-y: auto;
    margin-bottom: 15px;
  }
  .list-section h3 {
    margin: 8px 0 6px 0;
    font-weight: 700;
    font-size: 14px;
    color: var(--accent-2);
    border-bottom: 1px solid var(--accent-2);
    padding-bottom: 4px;
  }
  .item {
    padding: 8px;
    cursor: pointer;
    border-radius: 6px;
    display: flex;
    align-items: center;
    gap: 8px;
    user-select: none;
  }
  .item:hover {
    background: var(--accent);
  }
  .item.selected {
    background: var(--accent-2);
  }
  .avatar {
    width: 30px; height: 30px;
    background: var(--accent);
    border-radius: 6px;
    color: white;
    font-weight: 700;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .status {
    font-size: 11px;
    color: var(--muted);
    margin-left: auto;
  }

  /* Chat panel */
  #chat-panel {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: linear-gradient(180deg,#240606,#2a0f0f);
    padding: 10px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.6);
  }

  #chat-header {
    font-weight: 700;
    color: var(--accent-2);
    margin-bottom: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  #chat-messages {
    flex: 1;
    overflow-y: auto;
    padding-right: 8px;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .msg {
    max-width: 70%;
    padding: 10px 14px;
    border-radius: 12px;
    background: #4a0a0a;
    color: var(--nice);
    word-break: break-word;
    box-shadow: 0 4px 10px rgba(0,0,0,0.4);
  }
  .msg.mine {
    align-self: flex-end;
    background: linear-gradient(180deg,var(--accent),#8b0000);
  }
  .msg .meta {
    font-size: 12px;
    color: var(--muted);
    margin-bottom: 4px;
    font-weight: 700;
  }
  #input-area {
    margin-top: 10px;
    display: flex;
    gap: 8px;
  }
  #message-input {
    flex: 1;
    border-radius: 8px;
    border: none;
    padding: 10px;
    font-size: 15px;
    background: var(--glass);
    color: var(--nice);
    resize: none;
  }
  #send-btn {
    background: linear-gradient(90deg,var(--accent),#ff3b3b);
    border: none;
    color: white;
    padding: 0 20px;
    font-weight: 700;
    border-radius: 8px;
    cursor: pointer;
  }

  /* –ê–¥–º–∏–Ω –∫–æ–Ω—Å–æ–ª—å */
  #admin-console {
    background: var(--panel);
    color: var(--nice);
    padding: 10px;
    font-size: 14px;
    margin-top: 12px;
    border-radius: 8px;
    max-height: 150px;
    overflow-y: auto;
    display: none;
    flex-direction: column;
  }
  #admin-console h3 {
    margin-top: 0;
    margin-bottom: 8px;
    color: var(--accent-2);
  }
  .admin-action {
    margin-bottom: 8px;
  }
  .admin-action label {
    margin-right: 6px;
  }
  .admin-action input {
    border-radius: 4px;
    border: none;
    padding: 4px 6px;
    width: 140px;
  }
  .admin-action button {
    background: var(--accent);
    border: none;
    color: white;
    padding: 6px 10px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 700;
  }

  /* –†–µ–∫–ª–∞–º–∞ –≤–Ω–∏–∑—É —Å–ø—Ä–∞–≤–∞ */
  #ad-container {
    position: fixed;
    bottom: 12px;
    right: 12px;
    width: 220px;
    height: 70px;
    background: rgba(0,0,0,0.5);
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 0 8px var(--accent);
    z-index: 9999;
  }
  #ad-container iframe {
    width: 100%;
    height: 100%;
    border: 0;
  }

  /* –ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è */
  @media (max-width: 700px) {
    main {
      flex-direction: column;
    }
    #sidebar {
      width: 100%;
      height: 120px;
      display: flex;
      overflow-x: auto;
      overflow-y: hidden;
      padding: 5px;
      box-sizing: border-box;
    }
    .list-section {
      margin-bottom: 0;
      display: flex;
      flex-direction: row;
      gap: 12px;
      overflow-x: auto;
    }
    .item {
      flex: 0 0 auto;
      padding: 6px 10px;
      border-radius: 12px;
      font-size: 13px;
    }
    #chat-panel {
      flex: 1;
      height: calc(100vh - 200px);
    }
    #ad-container {
      width: 180px;
      height: 60px;
      bottom: 8px;
      right: 8px;
    }
  }
</style>
</head>
<body>

<div id="app">
  <header>
    <div class="title">ZetGram üî¥</div>
    <div class="user-info" id="user-info">
      <!-- info + –∫–Ω–æ–ø–∫–∞ –≤—ã—Ö–æ–¥–∞ -->
    </div>
  </header>

  <main>
    <aside id="sidebar" aria-label="–°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –≥—Ä—É–ø–ø">
      <div class="list-section" id="users-section">
        <h3>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h3>
        <div id="users-list"></div>
      </div>
      <div class="list-section" id="groups-section">
        <h3>–ì—Ä—É–ø–ø—ã</h3>
        <div id="groups-list"></div>
      </div>
    </aside>

    <section id="chat-panel" aria-label="–ß–∞—Ç">
      <div id="chat-header">–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞</div>
      <div id="chat-messages" role="log" aria-live="polite" aria-relevant="additions"></div>
      <div id="input-area">
        <textarea id="message-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." rows="2"></textarea>
        <button id="send-btn" aria-label="–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>

      <div id="admin-console">
        <h3>–ê–¥–º–∏–Ω –∫–æ–Ω—Å–æ–ª—å</h3>
        <div class="admin-action">
          <label for="admin-user-id">User ID:</label>
          <input type="text" id="admin-user-id" placeholder="UID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" />
          <button id="btn-mute">–ú—É—Ç</button>
          <button id="btn-ban">–ë–∞–Ω</button>
        </div>
        <div>
          <button id="btn-view-all-ls">–ß–∏—Ç–∞—Ç—å –≤—Å–µ –õ–°</button>
          <button id="btn-view-normal">–ù–∞–∑–∞–¥ –∫ –æ–±—ã—á–Ω–æ–º—É —á–∞—Ç—É</button>
        </div>
        <div id="admin-log" style="margin-top:8px; max-height: 60px; overflow-y: auto; font-size: 12px; color: var(--muted);"></div>
      </div>
    </section>
  </main>

  <div id="ad-container" aria-hidden="true">
    <iframe data-aa="2406373" src="//acceptable.a-ads.com/2406373/?size=Adaptive&background_color=ddd&title_color=b27&title_hover_color=fffefe"></iframe>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import {
    getAuth,
    signInWithEmailAndPassword,
    createUserWithEmailAndPassword,
    onAuthStateChanged,
    signOut,
    updateProfile
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
  import {
    getDatabase,
    ref,
    set,
    push,
    onChildAdded,
    onChildRemoved,
    query,
    orderByChild,
    onValue,
    remove,
    onDisconnect
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

  // ----------- Firebase config (–∑–∞–º–µ–Ω–∏ –Ω–∞ —Å–≤–æ–π) --------------
  const firebaseConfig = {
    apiKey: "–¢–í–û–ô_API_KEY",
    authDomain: "–¢–í–û–ô_AUTH_DOMAIN",
    databaseURL: "–¢–í–û–ô_DATABASE_URL",
    projectId: "–¢–í–û–ô_PROJECT_ID",
    storageBucket: "–¢–í–û–ô_STORAGE_BUCKET",
    messagingSenderId: "–¢–í–û–ô_MESSAGING_SENDER_ID",
    appId: "–¢–í–û–ô_APP_ID"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  // UI —ç–ª–µ–º–µ–Ω—Ç—ã
  const userInfoEl = document.getElementById('user-info');
  const usersListEl = document.getElementById('users-list');
  const groupsListEl = document.getElementById('groups-list');
  const chatHeaderEl = document.getElementById('chat-header');
  const chatMessagesEl = document.getElementById('chat-messages');
  const messageInput = document.getElementById('message-input');
  const sendBtn = document.getElementById('send-btn');
  const adminConsole = document.getElementById('admin-console');
  const adminUserIdInput = document.getElementById('admin-user-id');
  const btnMute = document.getElementById('btn-mute');
  const btnBan = document.getElementById('btn-ban');
  const btnViewAllLS = document.getElementById('btn-view-all-ls');
  const btnViewNormal = document.getElementById('btn-view-normal');
  const adminLog = document.getElementById('admin-log');

  // –°–æ—Å—Ç–æ—è–Ω–∏–µ
  let currentUser = null;
  let currentChatId = null; // uid –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ group id
  let isGroupChat = false;
  let isAdmin = false;
  let viewAllLS = false;

  // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, –ì—Ä—É–ø–ø—ã
  const users = new Map(); // uid -> {username, online}
  const groups = new Map(); // groupId -> {name, members}

  // –ú—É—Ç—ã –∏ –±–∞–Ω—ã
  const mutedUsers = new Set();
  const bannedUsers = new Set();

  // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
  function el(tag, cls, text) {
    const e = document.createElement(tag);
    if(cls) e.className = cls;
    if(text !== undefined) e.textContent = text;
    return e;
  }
  function initials(name){
    if(!name) return '??';
    return name.split(' ').map(s=>s[0]?.toUpperCase()||'').slice(0,2).join('');
  }
  function colorFromString(s){
    let h=0; for(let i=0;i<s.length;i++) h = (h<<5)-h + s.charCodeAt(i);
    const hue = Math.abs(h)%360;
    return `hsl(${hue} 80% 35%)`;
  }
  function timeString(ts){
    const d = new Date(ts);
    return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
  }

  // –†–µ–Ω–¥–µ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –≥—Ä—É–ø–ø
  function renderUser(uid, data){
    users.set(uid, data);
    updateUsersList();
  }
  function updateUsersList(){
    usersListEl.innerHTML = '';
    for(const [uid, data] of users.entries()){
      if(bannedUsers.has(uid)) continue; // –±–∞–Ω ‚Äî –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
      const item = el('div','item');
      if(uid === currentUser.uid) item.style.fontWeight = '700';
      item.dataset.uid = uid;
      item.dataset.type = 'user';
      if(uid === currentChatId && !isGroupChat) item.classList.add('selected');

      const avatar = el('div','avatar', initials(data.username));
      avatar.style.background = colorFromString(data.username);
      const name = el('span');
      name.textContent = data.username + (data.online ? ' (–æ–Ω–ª–∞–π–Ω)' : ' (–æ—Ñ–ª–∞–π–Ω)');

      item.appendChild(avatar);
      item.appendChild(name);
      usersListEl.appendChild(item);
    }
  }
  function renderGroup(id, data){
    groups.set(id, data);
    updateGroupsList();
  }
  function updateGroupsList(){
    groupsListEl.innerHTML = '';
    for(const [id, data] of groups.entries()){
      const item = el('div','item');
      item.dataset.uid = id;
      item.dataset.type = 'group';
      if(id === currentChatId && isGroupChat) item.classList.add('selected');
      const avatar = el('div','avatar', data.name[0].toUpperCase());
      avatar.style.background = colorFromString(data.name);
      const name = el('span');
      name.textContent = data.name + ` (${data.members.length})`;
      item.appendChild(avatar);
      item.appendChild(name);
      groupsListEl.appendChild(item);
    }
  }

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –≥—Ä—É–ø–ø—ã
  function selectChat(uid, group=false){
    currentChatId = uid;
    isGroupChat = group;
    updateUsersList();
    updateGroupsList();
    chatHeaderEl.textContent = group
      ? `–ì—Ä—É–ø–ø–∞: ${groups.get(uid)?.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}`
      : `–õ–°: ${users.get(uid)?.username || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}`;
    loadMessages();
  }

  // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ Firebase
  let unsubscribeMessages = null;
  function loadMessages(){
    chatMessagesEl.innerHTML = '';
    if(unsubscribeMessages) unsubscribeMessages();

    if(!currentChatId) return;

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–π:
    // –µ—Å–ª–∏ isGroupChat - messages/groups/{groupId}
    // –∏–Ω–∞—á–µ - messages/ls/{user1_user2}, –≥–¥–µ user1 < user2 –ø–æ id
    let messagesPath = '';
    if(isGroupChat){
      messagesPath = `messages/groups/${currentChatId}`;
    } else {
      const u1 = currentUser.uid;
      const u2 = currentChatId;
      const chatKey = u1 < u2 ? u1 + '_' + u2 : u2 + '_' + u1;
      messagesPath = `messages/ls/${chatKey}`;
    }

    const messagesRef = ref(db, messagesPath);

    unsubscribeMessages = onChildAdded(messagesRef, snapshot=>{
      const msg = snapshot.val();
      if(!msg) return;

      // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –º—É—Ç–µ ‚Äî –Ω–µ –≤—ã–≤–æ–¥–∏–º –µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
      if(mutedUsers.has(msg.sender)) return;
      if(bannedUsers.has(msg.sender)) return;

      // –î–ª—è –∞–¥–º–∏–Ω–∞, –µ—Å–ª–∏ viewAllLS=true ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –õ–°, –∏–Ω–∞—á–µ —Ñ–∏–ª—å—Ç—Ä—É–µ–º

      // –î–ª—è –õ–°, –µ—Å–ª–∏ viewAllLS=false, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —á–∞—Ç —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º
      if(!isGroupChat && !viewAllLS && msg.sender !== currentChatId && msg.sender !== currentUser.uid) {
        return; // –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º —á—É–∂–∏–µ –õ–°
      }

      // –î–ª—è –≥—Ä—É–ø–ø ‚Äî –≤—Å–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º

      const msgEl = el('div','msg');
      if(msg.sender === currentUser.uid) msgEl.classList.add('mine');
      const senderName = users.get(msg.sender)?.username || (isGroupChat ? '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ' : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å');
      const meta = el('div','meta', `${senderName} | ${timeString(msg.timestamp)}`);
      const content = el('div','content');
      content.textContent = msg.text;

      msgEl.appendChild(meta);
      msgEl.appendChild(content);
      chatMessagesEl.appendChild(msgEl);
      chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
    });
  }

  // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
  sendBtn.addEventListener('click', sendMessage);
  messageInput.addEventListener('keydown', e=>{
    if(e.key === 'Enter' && !e.shiftKey){
      e.preventDefault();
      sendMessage();
    }
  });

  function sendMessage(){
    const text = messageInput.value.trim();
    if(!text || !currentChatId) return;

    if(mutedUsers.has(currentUser.uid)){
      alert('–í—ã –≤ –º—É—Ç–µ –∏ –Ω–µ –º–æ–∂–µ—Ç–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è.');
      return;
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–Ω–∞
    if(bannedUsers.has(currentUser.uid)){
      alert('–í—ã –∑–∞–±–∞–Ω–µ–Ω—ã –∏ –Ω–µ –º–æ–∂–µ—Ç–µ –ø–∏—Å–∞—Ç—å.');
      return;
    }

    // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ Firebase
    let messagesPath = '';
    if(isGroupChat){
      messagesPath = `messages/groups/${currentChatId}`;
    } else {
      const u1 = currentUser.uid;
      const u2 = currentChatId;
      const chatKey = u1 < u2 ? u1 + '_' + u2 : u2 + '_' + u1;
      messagesPath = `messages/ls/${chatKey}`;
    }
    const messagesRef = ref(db, messagesPath);
    const newMsgRef = push(messagesRef);
    set(newMsgRef, {
      sender: currentUser.uid,
      text,
      timestamp: Date.now()
    });
    messageInput.value = '';
  }

  // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏ –≤—Ö–æ–¥
  function renderLogin() {
    userInfoEl.innerHTML = '';

    const container = el('div');
    const loginForm = el('form');
    loginForm.innerHTML = `
      <input type="email" id="login-email" placeholder="Email" required style="padding:6px;margin:4px 0;border-radius:6px;border:none;width: 220px;">
      <input type="password" id="login-password" placeholder="–ü–∞—Ä–æ–ª—å" required style="padding:6px;margin:4px 0;border-radius:6px;border:none;width: 220px;">
      <div style="display:flex; gap:10px; margin-top:6px;">
        <button type="submit" style="flex:1; padding:8px; border:none; border-radius:6px; background: var(--accent); color:#fff; font-weight:700; cursor:pointer;">–í–æ–π—Ç–∏</button>
        <button type="button" id="to-register" style="flex:1; padding:8px; border:none; border-radius:6px; background:#660000; color:#fff; font-weight:700; cursor:pointer;">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
      </div>
      <div id="login-error" style="color:#ff5555; margin-top:6px;"></div>
    `;
    container.appendChild(loginForm);
    userInfoEl.appendChild(container);

    // –ù–∞–≤–µ—Å–∏–º —Å–æ–±—ã—Ç–∏—è
    loginForm.addEventListener('submit', e=>{
      e.preventDefault();
      const email = loginForm.querySelector('#login-email').value.trim();
      const pass = loginForm.querySelector('#login-password').value.trim();
      loginUser(email, pass);
    });

    container.querySelector('#to-register').onclick = () => {
      renderRegister();
    };
  }
  function renderRegister() {
    userInfoEl.innerHTML = '';
    const container = el('div');
    const regForm = el('form');
    regForm.innerHTML = `
      <input type="email" id="reg-email" placeholder="Email" required style="padding:6px;margin:4px 0;border-radius:6px;border:none;width: 220px;">
      <input type="text" id="reg-username" placeholder="–ù–∏–∫–Ω–µ–π–º" required style="padding:6px;margin:4px 0;border-radius:6px;border:none;width: 220px;">
      <input type="password" id="reg-password" placeholder="–ü–∞—Ä–æ–ª—å" required style="padding:6px;margin:4px 0;border-radius:6px;border:none;width: 220px;">
      <div style="display:flex; gap:10px; margin-top:6px;">
        <button type="submit" style="flex:1; padding:8px; border:none; border-radius:6px; background: var(--accent); color:#fff; font-weight:700; cursor:pointer;">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
        <button type="button" id="to-login" style="flex:1; padding:8px; border:none; border-radius:6px; background:#660000; color:#fff; font-weight:700; cursor:pointer;">–ù–∞–∑–∞–¥</button>
      </div>
      <div id="reg-error" style="color:#ff5555; margin-top:6px;"></div>
    `;
    container.appendChild(regForm);
    userInfoEl.appendChild(container);

    regForm.addEventListener('submit', e=>{
      e.preventDefault();
      const email = regForm.querySelector('#reg-email').value.trim();
      const username = regForm.querySelector('#reg-username').value.trim();
      const pass = regForm.querySelector('#reg-password').value.trim();
      registerUser(email, pass, username);
    });

    container.querySelector('#to-login').onclick = () => {
      renderLogin();
    };
  }

  async function registerUser(email, pass, username){
    try {
      const cred = await createUserWithEmailAndPassword(auth, email, pass);
      await updateProfile(cred.user, { displayName: username });
      await set(ref(db, `users/${cred.user.uid}`), {
        username,
        online: true,
        isAdmin: false // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –Ω–∏–∫—Ç–æ –Ω–µ –∞–¥–º–∏–Ω
      });
      currentUser = cred.user;
      isAdmin = false;
      startApp();
    } catch(e){
      const errEl = document.getElementById('reg-error');
      errEl.textContent = e.message;
    }
  }
  async function loginUser(email, pass){
    try {
      const cred = await signInWithEmailAndPassword(auth, email, pass);
      currentUser = cred.user;
      // –ó–∞–≥—Ä—É–∑–∏–º isAdmin –∏–∑ –ë–î
      onValue(ref(db, `users/${currentUser.uid}/isAdmin`), snap=>{
        isAdmin = !!snap.val();
        if(isAdmin) adminConsole.style.display = 'flex'; else adminConsole.style.display = 'none';
      }, {onlyOnce:true});
      await set(ref(db, `users/${currentUser.uid}/online`), true);
      startApp();
    } catch(e){
      const errEl = document.getElementById('login-error');
      errEl.textContent = e.message;
    }
  }

  function startApp(){
    userInfoEl.innerHTML = '';
    const info = el('div');
    info.textContent = `–í—ã: ${currentUser.displayName || currentUser.email}`;
    const logoutBtn = el('button');
    logoutBtn.textContent = '–í—ã–π—Ç–∏';
    logoutBtn.onclick = async () => {
      await set(ref(db, `users/${currentUser.uid}/online`), false);
      await signOut(auth);
      location.reload();
    };
    info.appendChild(logoutBtn);
    userInfoEl.appendChild(info);

    loadUsers();
    loadGroups();
    selectChat(null);
  }

  // –°–ª—É—à–∞–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
  onAuthStateChanged(auth, user=>{
    if(user){
      currentUser = user;
      loadUsers();
      loadGroups();
      startApp();
    } else {
      renderLogin();
    }
  });

  // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ –ë–î
  function loadUsers(){
    const usersRef = ref(db, 'users');
    onValue(usersRef, snapshot=>{
      const data = snapshot.val() || {};
      users.clear();
      for(const uid in data){
        users.set(uid, data[uid]);
      }
      updateUsersList();
    });
  }
  // –ü—Ä–∏–º–µ—Ä –≥—Ä—É–ø–ø ‚Äî –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–≤–æ—é –ª–æ–≥–∏–∫—É
  function loadGroups(){
    // –ü—Ä–∏–º–µ—Ä, 2 –≥—Ä—É–ø–ø—ã:
    groups.clear();
    groups.set('group1', {name: '–û–±—â–∏–π —á–∞—Ç', members: Array.from(users.keys())});
    groups.set('group2', {name: '–ê–¥–º–∏–Ω—ã', members: Array.from(users.entries()).filter(([uid,u])=>u.isAdmin).map(([uid])=>uid)});
    updateGroupsList();
  }

  // –ê–¥–º–∏–Ω —Ñ—É–Ω–∫—Ü–∏–∏
  btnMute.onclick = () => {
    const target = adminUserIdInput.value.trim();
    if(!users.has(target)){
      adminLog.textContent = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω';
      return;
    }
    mutedUsers.add(target);
    adminLog.textContent = `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${users.get(target).username} –≤ –º—É—Ç–µ`;
  };
  btnBan.onclick = () => {
    const target = adminUserIdInput.value.trim();
    if(!users.has(target)){
      adminLog.textContent = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω';
      return;
    }
    bannedUsers.add(target);
    adminLog.textContent = `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${users.get(target).username} –∑–∞–±–∞–Ω–µ–Ω`;
  };
  btnViewAllLS.onclick = () => {
    viewAllLS = true;
    adminLog.textContent = '–ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö –õ–° –≤–∫–ª—é—á–µ–Ω';
    if(currentChatId) loadMessages();
  };
  btnViewNormal.onclick = () => {
    viewAllLS = false;
    adminLog.textContent = '–í–æ–∑–≤—Ä–∞—Ç –∫ –æ–±—ã—á–Ω–æ–º—É —á–∞—Ç—É';
    if(currentChatId) loadMessages();
  };

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –∏ –≥—Ä—É–ø–ø–∞–º
  usersListEl.addEventListener('click', e=>{
    const item = e.target.closest('.item');
    if(!item) return;
    if(item.dataset.type === 'user'){
      selectChat(item.dataset.uid, false);
    }
  });
  groupsListEl.addEventListener('click', e=>{
    const item = e.target.closest('.item');
    if(!item) return;
    if(item.dataset.type === 'group'){
      selectChat(item.dataset.uid, true);
    }
  });

</script>

</body>
</html>
