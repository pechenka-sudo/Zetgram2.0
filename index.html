<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ZetGram ‚Äî Chat</title>

<style>
:root{
  --bg:#1a0000; --panel:#2a0f0f; --accent:#b30000; --accent-2:#ff4c4c; --muted:#ff9999;
  --glass: rgba(255,255,255,0.03);
  --nice: #ffefef;
}
*{box-sizing:border-box}
html,body{height:100%; margin:0; font-family: Inter,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--nice); -webkit-font-smoothing:antialiased}
.app{
  height:100vh; display:flex; flex-direction:column;
}
.header{
  display:flex; align-items:center; justify-content:space-between;
  padding:12px 16px; background:linear-gradient(90deg,var(--accent),#7e0000);
  box-shadow: 0 3px 10px rgba(0,0,0,0.5);
}
.header .title{font-weight:700; font-size:18px}
.header .user-info{display:flex; gap:10px; align-items:center; cursor:pointer}

/* main layout */
.container{
  flex:1; display:flex; gap:12px; padding:12px;
  min-height: 0;
}
.sidebar{
  width:250px; max-width:30%;
  background:var(--panel); border-radius:12px; padding:12px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.4);
  display:flex; flex-direction:column;
  min-height: 0;
}
.sidebar h3{
  margin:0 0 10px 0; color:var(--accent-2);
  user-select:none;
}
.users-list, .groups-list {
  overflow-y:auto;
  flex:1;
  display:flex; flex-direction:column; gap:8px; padding-right:6px;
  min-height: 0;
}
.user-row, .group-row {
  display:flex; gap:8px; align-items:center; padding:8px; border-radius:8px;
  cursor:pointer;
  background: transparent;
  transition: background-color 0.3s ease;
}
.user-row:hover, .group-row:hover {
  background: var(--accent);
}
.user-row.active, .group-row.active {
  background: var(--accent-2);
  font-weight: 700;
}
.user-row .avatar, .group-row .avatar{
  width:40px;height:40px;border-radius:8px; display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff;
  user-select:none;
}
.user-row .meta, .group-row .meta{
  display:flex;flex-direction:column;
  user-select:none;
}
.user-row .meta .name, .group-row .meta .name{
  font-weight:600;
}
.user-row .status{
  font-size:12px; color:var(--muted);
}

/* main chat panel */
.panel{
  flex:1; display:flex; flex-direction:column; border-radius:12px; background: linear-gradient(180deg,#240606,#2a0f0f);
  padding:10px; box-shadow: 0 8px 30px rgba(0,0,0,0.6);
  min-width:320px;
  min-height: 0;
}

/* messages */
.messages{
  flex:1; overflow-y:auto; padding:12px; display:flex; flex-direction:column; gap:10px;
  scroll-behavior:smooth;
  min-height: 0;
}
.message{
  max-width:72%; padding:10px 12px; border-radius:12px; position:relative;
  box-shadow: 0 4px 12px rgba(0,0,0,0.4);
  word-break:break-word; background: #4a0a0a;
}
.message.mine{align-self:flex-end; background: linear-gradient(180deg,var(--accent),#8b0000)}
.message .meta{display:flex; gap:8px; align-items:center; margin-bottom:6px}
.avatar-sm{width:36px;height:36px;border-radius:8px;display:inline-flex;align-items:center;justify-content:center;font-weight:700;color:white}
.author{font-weight:700; color:var(--accent-2)}
.time{font-size:12px;color:var(--muted); margin-left:6px}
.msg-text{font-size:15px; margin-bottom:6px}
.msg-img{display:block; max-width:320px; border-radius:8px; margin-top:6px; box-shadow: 0 6px 16px rgba(0,0,0,0.5)}

/* delete button */
.del-btn{position:absolute; top:6px; right:6px; background:transparent; border:none; color:var(--muted); font-weight:700; cursor:pointer}

/* input area */
.input-bar{
  display:flex; gap:8px; align-items:center; margin-top:8px; padding-top:8px; border-top:1px solid rgba(255,0,0,0.06)
}
.input-field{
  flex:1; display:flex; gap:8px; align-items:center; background:var(--glass); padding:8px; border-radius:10px;
}
textarea{
  flex:1; resize:none; padding:8px; border-radius:8px; background:transparent; border:none; color:var(--nice); outline:none; font-size:15px;
  min-height: 60px;
}
.file-btn{
  background:transparent; border:2px dashed rgba(255,255,255,0.06); padding:6px;border-radius:8px; color:var(--muted); cursor:pointer;
}
.send-btn{
  background:linear-gradient(90deg,var(--accent),#ff3b3b); border:none; color:white; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:700;
}

/* bottom-right floating button for new chat */
.new-chat-btn{
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: var(--accent-2);
  color: white;
  border: none;
  border-radius: 50%;
  width: 56px;
  height: 56px;
  font-size: 32px;
  font-weight: 700;
  line-height: 56px;
  text-align: center;
  cursor: pointer;
  box-shadow: 0 4px 12px rgba(255,0,0,0.5);
  transition: background-color 0.3s ease;
  z-index: 100000;
}
.new-chat-btn:hover {
  background: #ff4c4c;
}

/* popup modal background */
.modal-bg {
  position: fixed;
  top:0; left:0; width:100%; height:100%;
  background: rgba(0,0,0,0.7);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 100001;
}

/* modal window */
.modal {
  background: var(--panel);
  border-radius: 12px;
  padding: 20px;
  width: 320px;
  max-width: 90vw;
  color: var(--nice);
  box-shadow: 0 0 20px var(--accent-2);
  user-select:none;
}

.modal h2 {
  margin-top: 0;
  margin-bottom: 16px;
  color: var(--accent-2);
  font-weight: 700;
  text-align: center;
}

.modal label {
  display: block;
  margin-bottom: 8px;
  font-weight: 600;
}

.modal input[type="text"],
.modal input[type="email"],
.modal input[type="password"] {
  width: 100%;
  padding: 8px;
  margin-bottom: 12px;
  border-radius: 8px;
  border: none;
  background: var(--glass);
  color: var(--nice);
  outline: none;
  font-size: 15px;
}

.modal button {
  width: 100%;
  padding: 10px;
  border-radius: 10px;
  border: none;
  background: var(--accent-2);
  color: white;
  font-weight: 700;
  cursor: pointer;
  transition: background-color 0.3s ease;
  user-select:none;
}

.modal button:hover {
  background: #ff4c4c;
}

/* small text under modal */
.modal .small-text {
  font-size: 13px;
  color: var(--muted);
  margin-top: 8px;
  text-align: center;
  user-select:none;
}

/* Ad banner bottom right, small */
#adBanner {
  position: fixed;
  bottom: 10px;
  right: 10px;
  width: 200px;
  max-width: 90vw;
  background: rgba(0,0,0,0.5);
  border-radius: 8px;
  z-index: 99999;
  box-shadow: 0 0 10px var(--accent);
  user-select:none;
}
#adBanner iframe {
  width: 100%;
  height: 60px;
  border: none;
  border-radius: 8px;
  display: block;
}

/* Responsive */
@media(max-width:900px){
  .container{
    flex-direction: column;
    padding: 8px;
  }
  .sidebar{
    width: 100%;
    max-width: none;
    margin-bottom: 12px;
    min-height: auto;
  }
  .panel{
    min-width: auto;
    min-height: 400px;
  }
  .messages {
    max-height: 50vh;
  }
  .new-chat-btn {
    width: 48px;
    height: 48px;
    font-size: 28px;
    line-height: 48px;
    bottom: 15px;
    right: 15px;
  }
}
</style>
</head>
<body>
<div class="app" role="application" aria-label="ZetGram chat">

  <div class="header" role="banner">
    <div class="title">ZetGram üî¥</div>
    <div class="user-info" id="headerUser" title="–î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ ‚Äî –≤—ã–π—Ç–∏"></div>
  </div>

  <div class="container" role="main">
    <nav class="sidebar" aria-label="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏ –≥—Ä—É–ø–ø—ã">
      <h3>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h3>
      <div class="users-list" id="usersList" tabindex="0"></div>
      <h3 style="margin-top: 20px;">–ì—Ä—É–ø–ø—ã</h3>
      <div class="groups-list" id="groupsList" tabindex="0"></div>
    </nav>

    <section class="panel" aria-live="polite">
      <div class="messages" id="messages" tabindex="0" aria-label="–ß–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏—è"></div>

      <div class="input-bar" role="region" aria-label="–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è">
        <div class="input-field">
          <textarea id="textInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (Enter ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å, Shift+Enter ‚Äî –Ω–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞)"></textarea>
          <input id="fileInput" class="file-btn" type="file" accept="image/*" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ" />
        </div>
        <button class="send-btn" id="sendBtn" aria-label="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>
    </section>
  </div>

  <button class="new-chat-btn" id="newChatBtn" title="–ù–æ–≤—ã–π —á–∞—Ç +"></button>

  <div id="adBanner" aria-hidden="true">
    <iframe data-aa="2406373" src="//acceptable.a-ads.com/2406373/?size=Adaptive" referrerpolicy="no-referrer"></iframe>
  </div>

  <!-- Auth/Register Modal -->
  <div class="modal-bg" id="authModal" role="dialog" aria-modal="true" aria-labelledby="authTitle">
    <div class="modal">
      <h2 id="authTitle">–í—Ö–æ–¥ –∏–ª–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>

      <div id="authError" style="color:#ff4c4c; font-weight:bold; margin-bottom: 10px; display:none;"></div>

      <form id="authForm">
        <label for="nicknameInput">–ù–∏–∫ (–¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏)</label>
        <input type="text" id="nicknameInput" autocomplete="username" placeholder="–¢–æ–ª—å–∫–æ –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏" />

        <label for="emailInput">Email</label>
        <input type="email" id="emailInput" autocomplete="email" required />

        <label for="passwordInput">–ü–∞—Ä–æ–ª—å</label>
        <input type="password" id="passwordInput" autocomplete="current-password" required minlength="6" />

        <button type="submit" id="authSubmitBtn">–í–æ–π—Ç–∏</button>
      </form>

      <div class="small-text" id="toggleAuthText">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a href="#" id="toggleAuthLink">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a></div>
    </div>
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import {
  getAuth,
  signInWithEmailAndPassword,
  createUserWithEmailAndPassword,
  onAuthStateChanged,
  signOut,
  updateProfile
} from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
import {
  getDatabase,
  ref,
  push,
  onChildAdded,
  onChildRemoved,
  query,
  orderByChild,
  set,
  onValue,
  remove,
  onDisconnect
} from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";
import {
  getStorage,
  ref as storageRef,
  uploadBytes,
  getDownloadURL
} from "https://www.gstatic.com/firebasejs/12.1.0/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyDTZrRKHrmKnA9ycBWvt9ephnr7TN6ZFs8",
  authDomain: "zetgram-d2b77.firebaseapp.com",
  databaseURL: "https://zetgram-d2b77-default-rtdb.firebaseio.com",
  projectId: "zetgram-d2b77",
  storageBucket: "zetgram-d2b77.firebasestorage.app",
  messagingSenderId: "804686454",
  appId: "1:804686454:web:db9f618955e3d370deed57",
  measurementId: "G-KCYSRCX4ZL"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);
const storage = getStorage(app);

// UI refs
const headerUser = document.getElementById('headerUser');
const usersListEl = document.getElementById('usersList');
const groupsListEl = document.getElementById('groupsList');
const messagesEl = document.getElementById('messages');
const textInput = document.getElementById('textInput');
const fileInput = document.getElementById('fileInput');
const sendBtn = document.getElementById('sendBtn');
const newChatBtn = document.getElementById('newChatBtn');

const authModal = document.getElementById('authModal');
const authForm = document.getElementById('authForm');
const authError = document.getElementById('authError');
const nicknameInput = document.getElementById('nicknameInput');
const emailInput = document.getElementById('emailInput');
const passwordInput = document.getElementById('passwordInput');
const authSubmitBtn = document.getElementById('authSubmitBtn');
const toggleAuthText = document.getElementById('toggleAuthText');
const toggleAuthLink = document.getElementById('toggleAuthLink');

let currentUser = null;
let currentChatId = null; // uid for private, 'group:<groupId>' for group chats
let chats = {}; // chatId -> {type:'user'|'group'|'admin', members:[], name:string}
let displayedMessages = new Set();
let groups = [
  { id: 'group1', name: '–û–±—â–∏–π —á–∞—Ç' },
  { id: 'admins', name: '–ê–¥–º–∏–Ω—Å–∫–∞—è –∫–æ–Ω—Å–æ–ª—å', adminOnly: true }
];

// Helpers

function el(tag, cls, txt){
  const e = document.createElement(tag);
  if(cls) e.className = cls;
  if(txt !== undefined) e.textContent = txt;
  return e;
}

function timeString(ts){
  const d = new Date(ts);
  return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
}

function initials(name){
  if(!name) return '??';
  return name.split(' ').map(s=>s[0]?.toUpperCase()||'').slice(0,2).join('');
}

function colorFromString(s){
  let h=0; for(let i=0;i<s.length;i++) h = (h<<5)-h + s.charCodeAt(i);
  const hue = Math.abs(h)%360;
  return `hsl(${hue} 80% 35%)`;
}

// --- AUTH & PRESENCE ---

function setPresence(user){
  if(!user) return;
  const userRef = ref(db, 'users/' + user.uid);
  set(userRef, { username: user.displayName || (user.email && user.email.split('@')[0]) || '–ë–µ–∑ –∏–º–µ–Ω–∏', online: true, lastSeen: Date.now(), uid: user.uid });
  onDisconnect(userRef).set({ username: user.displayName || (user.email && user.email.split('@')[0]) || '–ë–µ–∑ –∏–º–µ–Ω–∏', online: false, lastSeen: Date.now(), uid: user.uid });
}

onAuthStateChanged(auth, async (user) => {
  if(user){
    currentUser = user;
    setPresence(user);
    headerUser.innerHTML = `<div style="display:flex;align-items:center;gap:8px;user-select:none">–í—ã: <strong>${user.displayName || user.email.split('@')[0]}</strong> ‚Äî <button id="logoutBtn">–í—ã–π—Ç–∏</button></div>`;
    document.getElementById('logoutBtn').onclick = async () => {
      await signOut(auth);
      location.reload();
    };
    authModal.style.display = 'none';
    loadUsers();
    loadGroups();
    switchChat('group1'); // –æ—Ç–∫—Ä—ã–≤–∞–µ–º –æ–±—â–∏–π —á–∞—Ç
  } else {
    currentUser = null;
    authModal.style.display = 'flex';
    headerUser.textContent = '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω';
    clearMessages();
    clearUsers();
    clearGroups();
  }
});

// –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è/–í—Ö–æ–¥

let isRegister = false;

toggleAuthLink.onclick = (e) => {
  e.preventDefault();
  isRegister = !isRegister;
  authSubmitBtn.textContent = isRegister ? '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è' : '–í–æ–π—Ç–∏';
  toggleAuthText.innerHTML = isRegister
    ? '–ï—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <a href="#" id="toggleAuthLink">–í–æ–π—Ç–∏</a>'
    : '–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a href="#" id="toggleAuthLink">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a>';
  // –ß—Ç–æ–±—ã —Å—Å—ã–ª–∫–∞ —Ä–∞–±–æ—Ç–∞–ª–∞ —Å–Ω–æ–≤–∞
  document.getElementById('toggleAuthLink').onclick = toggleAuthLink.onclick;
  nicknameInput.style.display = isRegister ? 'block' : 'none';
  nicknameInput.value = '';
};

authForm.onsubmit = async (e) => {
  e.preventDefault();
  authError.style.display = 'none';
  try {
    if(isRegister){
      if(!nicknameInput.value.trim()) throw new Error('–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫ –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏');
      const userCred = await createUserWithEmailAndPassword(auth, emailInput.value.trim(), passwordInput.value);
      await updateProfile(userCred.user, { displayName: nicknameInput.value.trim() });
    } else {
      await signInWithEmailAndPassword(auth, emailInput.value.trim(), passwordInput.value);
    }
  } catch(err) {
    authError.textContent = err.message || '–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏';
    authError.style.display = 'block';
  }
};

// --- LOAD USERS AND GROUPS ---

function clearUsers(){
  usersListEl.innerHTML = '';
}
function clearGroups(){
  groupsListEl.innerHTML = '';
}
function clearMessages(){
  messagesEl.innerHTML = '';
  displayedMessages.clear();
}

async function loadUsers(){
  clearUsers();
  const usersRef = ref(db, 'users');
  onValue(usersRef, snapshot => {
    clearUsers();
    const val = snapshot.val() || {};
    // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ—Ö –∫—Ä–æ–º–µ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    Object.values(val).forEach(u=>{
      if(currentUser && u.uid === currentUser.uid) return;
      addUserRow(u);
    });
  });
}
function addUserRow(user){
  const elRow = el('div', 'user-row');
  elRow.dataset.uid = user.uid;
  elRow.tabIndex = 0;
  elRow.onclick = () => {
    switchChat(user.uid);
  };
  elRow.onkeydown = (e) => {
    if(e.key === 'Enter' || e.key === ' ') {
      switchChat(user.uid);
      e.preventDefault();
    }
  };
  const avatar = el('div', 'avatar', initials(user.username));
  avatar.style.backgroundColor = colorFromString(user.username);
  const meta = el('div', 'meta');
  const name = el('div', 'name', user.username);
  const status = el('div', 'status', user.online ? 'üü¢ –æ–Ω–ª–∞–π–Ω' : '‚ö™ –æ—Ñ–ª–∞–π–Ω');
  meta.append(name, status);
  elRow.append(avatar, meta);
  usersListEl.appendChild(elRow);
}

async function loadGroups(){
  clearGroups();
  groups.forEach(g=>{
    if(g.adminOnly && !isAdmin(currentUser)) return; // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–¥–º–∏–Ω—Å–∫—É—é –∫–æ–Ω—Å–æ–ª—å —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∞–º
    const elRow = el('div', 'group-row');
    elRow.dataset.gid = g.id;
    elRow.tabIndex = 0;
    elRow.onclick = () => {
      switchChat('group:' + g.id);
    };
    elRow.onkeydown = (e) => {
      if(e.key === 'Enter' || e.key === ' ') {
        switchChat('group:' + g.id);
        e.preventDefault();
      }
    };
    const avatar = el('div', 'avatar', g.name.split(' ').map(s=>s[0]).join(''));
    avatar.style.backgroundColor = '#6b0000';
    const meta = el('div', 'meta');
    const name = el('div', 'name', g.name);
    meta.append(name);
    elRow.append(avatar, meta);
    groupsListEl.appendChild(elRow);
  });
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (–≤ –¥–∞–Ω–Ω–æ–º –ø—Ä–∏–º–µ—Ä–µ –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º email)
function isAdmin(user){
  if(!user) return false;
  const adminsEmails = ['admin@example.com']; // –ó–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ –µ–º–µ–π–ª—ã –∞–¥–º–∏–Ω–æ–≤
  return adminsEmails.includes(user.email);
}

// --- CHAT ---

function switchChat(chatId){
  if(currentChatId === chatId) return;
  currentChatId = chatId;
  clearMessages();

  // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –≤ —Å–ø–∏—Å–∫–∞—Ö
  Array.from(usersListEl.children).forEach(c => c.classList.toggle('active', c.dataset.uid === chatId));
  Array.from(groupsListEl.children).forEach(c => c.classList.toggle('active', 'group:' + c.dataset.gid === chatId));

  listenMessages();
}

let messagesListener = null;

function listenMessages(){
  if(messagesListener) messagesListener();

  if(!currentChatId) return;

  const msgsRef = ref(db, 'messages/' + currentChatId);
  messagesListener = onChildAdded(msgsRef, snapshot => {
    const msg = snapshot.val();
    if(displayedMessages.has(snapshot.key)) return;
    displayedMessages.add(snapshot.key);
    addMessage(msg, snapshot.key);
  });
}

// –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç
function addMessage(msg, msgId){
  const mine = currentUser && msg.senderUid === currentUser.uid;
  const elMsg = el('div', 'message' + (mine ? ' mine' : ''));
  elMsg.id = 'msg-' + msgId;

  // –ú–µ—Ç–∞ - –∏–º—è + –≤—Ä–µ–º—è
  const meta = el('div', 'meta');
  const avatar = el('div', 'avatar-sm', initials(msg.senderName));
  avatar.style.backgroundColor = colorFromString(msg.senderName);
  const author = el('span', 'author', msg.senderName);
  const time = el('span', 'time', timeString(msg.timestamp));

  meta.append(avatar, author, time);
  elMsg.appendChild(meta);

  // –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
  const txt = el('div', 'msg-text');
  txt.textContent = msg.text || '';

  elMsg.appendChild(txt);

  // –ï—Å–ª–∏ –µ—Å—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫–∞
  if(msg.imageUrl){
    const img = document.createElement('img');
    img.src = msg.imageUrl;
    img.className = 'msg-img';
    elMsg.appendChild(img);
  }

  // –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –¥–ª—è —Å–≤–æ–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
  if(mine){
    const delBtn = el('button', 'del-btn', '√ó');
    delBtn.title = '–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ';
    delBtn.onclick = async () => {
      if(confirm('–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?')) {
        const msgRef = ref(db, `messages/${currentChatId}/${msgId}`);
        await remove(msgRef);
      }
    };
    elMsg.appendChild(delBtn);
  }

  messagesEl.appendChild(elMsg);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
async function sendMessage(){
  if(!currentUser) return alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
  const text = textInput.value.trim();
  if(!text && !fileInput.files.length) return;
  sendBtn.disabled = true;

  let imageUrl = null;
  if(fileInput.files.length){
    const file = fileInput.files[0];
    const imgRef = storageRef(storage, `chat_images/${currentChatId}/${Date.now()}_${file.name}`);
    await uploadBytes(imgRef, file);
    imageUrl = await getDownloadURL(imgRef);
  }

  const msgsRef = ref(db, 'messages/' + currentChatId);
  await push(msgsRef, {
    senderUid: currentUser.uid,
    senderName: currentUser.displayName || currentUser.email.split('@')[0],
    text: text || '',
    timestamp: Date.now(),
    imageUrl
  });

  textInput.value = '';
  fileInput.value = '';
  sendBtn.disabled = false;
  textInput.focus();
}

sendBtn.onclick = sendMessage;

textInput.addEventListener('keydown', e => {
  if(e.key === 'Enter' && !e.shiftKey){
    e.preventDefault();
    sendMessage();
  }
});

// –ù–æ–≤—ã–π —á–∞—Ç (—Å–±—Ä–æ—Å –≤—ã–¥–µ–ª–µ–Ω–∏—è, –≤—ã–±–æ—Ä –≥—Ä—É–ø–ø—ã –∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
newChatBtn.onclick = () => {
  currentChatId = null;
  clearMessages();
  Array.from(usersListEl.children).forEach(c => c.classList.remove('active'));
  Array.from(groupsListEl.children).forEach(c => c.classList.remove('active'));
  textInput.focus();
};

// --- End of script ---

</script>

</body>
  <style>
  #frame {
    position: fixed;
    bottom: 8px;
    left: 8px;
    width: 180px;
    height: 50px;
    background: rgba(0, 0, 0, 0.25);
    z-index: 99999;
    border-radius: 6px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    overflow: hidden;
    pointer-events: none; /* —á—Ç–æ–±—ã —Ä–µ–∫–ª–∞–º–∞ –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∞ –∫–ª–∏–∫–∏ –ø–æ –¥—Ä—É–≥–∏–º —ç–ª–µ–º–µ–Ω—Ç–∞–º */
  }
  #frame iframe {
    width: 100% !important;
    height: 100% !important;
    border: 0;
    display: block;
    pointer-events: auto; /* —á—Ç–æ–±—ã –∫–ª–∏–∫–∏ –ø–æ —Å–∞–º–æ–º—É iframe —Ä–∞–±–æ—Ç–∞–ª–∏ */
  }
</style>

<div id="frame" aria-label="–†–µ–∫–ª–∞–º–∞">
  <iframe 
    data-aa="2406373" 
    src="//acceptable.a-ads.com/2406373/?size=180x50&background_color=ddd&title_color=b27&title_hover_color=fffefe" 
    scrolling="no" 
    loading="lazy" 
    aria-hidden="true" 
    tabindex="-1"
  ></iframe>
</div>

</html>
