<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ZetGram Chat (Telegram-like)</title>
<style>
  :root {
    --bg: #1a0000;
    --panel: #2a0f0f;
    --accent: #b30000;
    --accent-2: #ff4c4c;
    --muted: #ff9999;
    --nice: #ffefef;
    --glass: rgba(255, 255, 255, 0.03);
  }
  * {
    box-sizing: border-box;
  }
  body, html {
    margin: 0; padding: 0;
    font-family: Inter,Segoe UI,Roboto,Arial,sans-serif;
    height: 100vh;
    background: var(--bg);
    color: var(--nice);
    overflow: hidden;
  }
  #header {
    height: 52px;
    background: linear-gradient(90deg, var(--accent), #7e0000);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 16px;
    font-weight: 700;
    font-size: 18px;
  }
  #header #userInfo {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  #header #userAvatar {
    width: 36px; height: 36px;
    border-radius: 8px;
    background-color: var(--accent-2);
    display: flex;
    justify-content: center;
    align-items: center;
    font-weight: 700;
    font-size: 18px;
    user-select: none;
  }
  #header #userName {
    font-weight: 700;
    user-select: none;
  }
  #logoutBtn {
    background: transparent;
    border: 1.5px solid var(--muted);
    border-radius: 8px;
    color: var(--muted);
    cursor: pointer;
    padding: 4px 10px;
    font-weight: 600;
    transition: background-color 0.2s ease;
  }
  #logoutBtn:hover {
    background-color: var(--accent-2);
    color: #fff;
  }

  #app {
    height: calc(100vh - 52px);
    display: flex;
    overflow: hidden;
  }
  #sidebar {
    width: 280px;
    background: var(--panel);
    padding: 12px;
    display: flex;
    flex-direction: column;
    box-shadow: 0 8px 20px rgba(0,0,0,0.4);
  }
  #sidebar h2 {
    margin: 0 0 12px 0;
    color: var(--accent-2);
    user-select: none;
  }
  #usersList, #groupsList {
    flex: 1;
    overflow-y: auto;
    margin-bottom: 12px;
  }
  .list-item {
    padding: 10px;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 12px;
    user-select: none;
    transition: background-color 0.15s ease;
  }
  .list-item:hover, .list-item.active {
    background: var(--accent);
  }
  .avatar-circle {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    background-color: var(--accent-2);
    color: white;
    font-weight: 700;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .item-info {
    display: flex;
    flex-direction: column;
  }
  .item-name {
    font-weight: 600;
  }
  .item-status {
    font-size: 12px;
    color: var(--muted);
  }

  #chatWrapper {
    flex: 1;
    background: linear-gradient(180deg, #240606, #2a0f0f);
    display: flex;
    flex-direction: column;
    border-radius: 0 12px 12px 0;
    box-shadow: 0 8px 30px rgba(0,0,0,0.6);
  }
  #chatHeader {
    padding: 12px 16px;
    font-weight: 700;
    border-bottom: 1px solid rgba(255,0,0,0.2);
    user-select: none;
  }
  #messages {
    flex: 1;
    overflow-y: auto;
    padding: 12px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    scroll-behavior: smooth;
  }
  .message {
    max-width: 70%;
    padding: 10px 12px;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    word-break: break-word;
    background: #4a0a0a;
    user-select: text;
  }
  .message.mine {
    align-self: flex-end;
    background: linear-gradient(180deg, var(--accent), #8b0000);
  }
  .message .meta {
    display: flex;
    gap: 8px;
    align-items: center;
    margin-bottom: 6px;
  }
  .avatar-sm {
    width: 36px;
    height: 36px;
    border-radius: 8px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    color: white;
  }
  .author {
    font-weight: 700;
    color: var(--accent-2);
  }
  .time {
    font-size: 12px;
    color: var(--muted);
    margin-left: 6px;
  }
  .msg-text {
    font-size: 15px;
  }
  .msg-img {
    display: block;
    max-width: 320px;
    border-radius: 8px;
    margin-top: 6px;
    box-shadow: 0 6px 16px rgba(0,0,0,0.5);
  }

  .del-btn {
    position: absolute;
    top: 6px;
    right: 6px;
    background: transparent;
    border: none;
    color: var(--muted);
    font-weight: 700;
    cursor: pointer;
  }

  #inputBar {
    display: flex;
    gap: 8px;
    align-items: center;
    margin-top: 8px;
    padding: 8px 12px;
    border-top: 1px solid rgba(255,0,0,0.06);
  }
  #textInput {
    flex: 1;
    resize: none;
    padding: 8px;
    border-radius: 8px;
    background: var(--glass);
    border: none;
    color: var(--nice);
    font-size: 15px;
    outline: none;
  }
  #fileInput {
    display: none;
  }
  #attachBtn {
    background: transparent;
    border: 2px dashed rgba(255,255,255,0.06);
    padding: 6px;
    border-radius: 8px;
    color: var(--muted);
    cursor: pointer;
    font-size: 18px;
  }
  #sendBtn {
    background: linear-gradient(90deg, var(--accent), #ff3b3b);
    border: none;
    color: white;
    padding: 8px 12px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 700;
  }

  /* Floating chat open button bottom right */
  #chatToggleBtn {
    position: fixed;
    bottom: 16px;
    right: 16px;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: var(--accent-2);
    border: none;
    color: white;
    font-size: 28px;
    font-weight: 700;
    cursor: pointer;
    box-shadow: 0 4px 8px rgba(255, 0, 0, 0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    user-select: none;
    z-index: 99999;
    transition: background-color 0.3s ease;
  }
  #chatToggleBtn:hover {
    background: var(--accent);
  }

  /* Hide chat area initially on small screens */
  #chatWrapper.hidden {
    display: none;
  }

  /* Scrollbar styling */
  ::-webkit-scrollbar {
    width: 8px;
    height: 8px;
  }
  ::-webkit-scrollbar-thumb {
    background: var(--accent-2);
    border-radius: 4px;
  }
  ::-webkit-scrollbar-track {
    background: var(--panel);
  }

  /* Small advertisement block */
  #adBlock {
    position: fixed;
    bottom: 80px;
    right: 16px;
    width: 220px;
    background: rgba(0,0,0,0.6);
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0,0,0,0.8);
    user-select: none;
    z-index: 99999;
  }
  #adBlock iframe {
    width: 100%;
    height: 60px;
    border: none;
    display: block;
  }

  /* Responsive */
  @media (max-width: 900px) {
    #sidebar {
      width: 200px;
    }
    #chatWrapper {
      display: none;
    }
    #chatWrapper.show {
      display: flex;
      position: fixed;
      top: 52px;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--bg);
      flex-direction: column;
      border-radius: 0;
      z-index: 99998;
    }
    #chatToggleBtn {
      bottom: 16px;
      right: 16px;
    }
  }
</style>
</head>
<body>

<div id="header">
  <div>ZetGram üî¥</div>
  <div id="userInfo" aria-live="polite">
    <!-- User info + logout button -->
  </div>
</div>

<div id="app" role="main">
  <div id="sidebar" aria-label="–°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –≥—Ä—É–ø–ø">
    <h2>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h2>
    <div id="usersList" tabindex="0" aria-label="–°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"></div>
    <h2>–ì—Ä—É–ø–ø—ã</h2>
    <div id="groupsList" tabindex="0" aria-label="–°–ø–∏—Å–æ–∫ –≥—Ä—É–ø–ø"></div>
  </div>

  <div id="chatWrapper" class="hidden" aria-label="–û–∫–Ω–æ —á–∞—Ç–∞" role="region">
    <div id="chatHeader" aria-live="polite">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç —Å–ª–µ–≤–∞</div>
    <div id="messages" tabindex="0" aria-label="–°–æ–æ–±—â–µ–Ω–∏—è —á–∞—Ç–∞"></div>
    <div id="inputBar" role="region" aria-label="–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è">
      <textarea id="textInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (Enter ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å, Shift+Enter ‚Äî –Ω–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞)" rows="2"></textarea>
      <label for="fileInput" id="attachBtn" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ">üìé</label>
      <input id="fileInput" type="file" accept="image/*" />
      <button id="sendBtn" aria-label="–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
  </div>
</div>

<button id="chatToggleBtn" aria-label="–û—Ç–∫—Ä—ã—Ç—å/–∑–∞–∫—Ä—ã—Ç—å —á–∞—Ç">üí¨</button>

<div id="adBlock" aria-hidden="true" title="–†–µ–∫–ª–∞–º–∞">
  <iframe data-aa="2406373" src="//acceptable.a-ads.com/2406373/?size=Responsive"></iframe>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import {
    getAuth,
    signInWithEmailAndPassword,
    createUserWithEmailAndPassword,
    onAuthStateChanged,
    signOut,
    updateProfile
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
  import {
    getDatabase,
    ref,
    set,
    get,
    push,
    onValue,
    onChildAdded,
    onChildRemoved,
    query,
    orderByChild,
    serverTimestamp,
    onDisconnect
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";
  import {
    getStorage,
    ref as storageRef,
    uploadBytes,
    getDownloadURL
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-storage.js";

  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyDTZrRKHrmKnA9ycBWvt9ephnr7TN6ZFs8",
    authDomain: "zetgram-d2b77.firebaseapp.com",
    databaseURL: "https://zetgram-d2b77-default-rtdb.firebaseio.com",
    projectId: "zetgram-d2b77",
    storageBucket: "zetgram-d2b77.appspot.com",
    messagingSenderId: "804686454",
    appId: "1:804686454:web:db9f618955e3d370deed57",
    measurementId: "G-KCYSRCX4ZL"
  };

  // Init Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);
  const storage = getStorage(app);

  // DOM refs
  const userInfo = document.getElementById('userInfo');
  const usersList = document.getElementById('usersList');
  const groupsList = document.getElementById('groupsList');
  const chatWrapper = document.getElementById('chatWrapper');
  const chatHeader = document.getElementById('chatHeader');
  const messagesEl = document.getElementById('messages');
  const textInput = document.getElementById('textInput');
  const fileInput = document.getElementById('fileInput');
  const sendBtn = document.getElementById('sendBtn');
  const chatToggleBtn = document.getElementById('chatToggleBtn');

  // Current chat data
  let currentChat = null; // { type: 'user'|'group', id: string, name: string }
  let currentUser = null;

  // --- Helpers ---
  function el(tag, cls, txt) {
    const e = document.createElement(tag);
    if (cls) e.className = cls;
    if (txt !== undefined) e.textContent = txt;
    return e;
  }
  function initials(name) {
    if (!name) return '??';
    return name.split(' ').map(s => s[0]?.toUpperCase() || '').slice(0, 2).join('');
  }
  function colorFromString(s) {
    let h = 0;
    for (let i = 0; i < s.length; i++) h = (h << 5) - h + s.charCodeAt(i);
    const hue = Math.abs(h) % 360;
    return `hsl(${hue} 80% 35%)`;
  }
  function timeString(ts) {
    const d = new Date(ts);
    return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  }
  function scrollToBottom() {
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  // --- Render user in sidebar ---
  function renderUser(uid, data) {
    let el = document.getElementById('user-' + uid);
    if (!el) {
      el = el = document.createElement('div');
      el.className = 'list-item';
      el.id = 'user-' + uid;
      el.tabIndex = 0;

      const av = el('div', 'avatar-circle');
      av.style.background = colorFromString(data.username || uid);
      av.textContent = initials(data.username || 'U');

      const info = el('div', 'item-info');
      const name = el('div', 'item-name', data.username || '–ë–µ–∑ –∏–º–µ–Ω–∏');
      const status = el('div', 'item-status', data.online ? '–æ–Ω–ª–∞–π–Ω' : '–Ω–µ –≤ —Å–µ—Ç–∏');

      info.appendChild(name);
      info.appendChild(status);

      el.appendChild(av);
      el.appendChild(info);

      el.addEventListener('click', () => openChat('user', uid, data.username || '–ë–µ–∑ –∏–º–µ–Ω–∏'));
      el.addEventListener('keypress', e => { if (e.key === 'Enter') el.click(); });

      usersList.appendChild(el);
    } else {
      // Update status and name
      el.querySelector('.item-name').textContent = data.username || '–ë–µ–∑ –∏–º–µ–Ω–∏';
      el.querySelector('.item-status').textContent = data.online ? '–æ–Ω–ª–∞–π–Ω' : '–Ω–µ –≤ —Å–µ—Ç–∏';
      el.querySelector('.avatar-circle').style.background = colorFromString(data.username || uid);
      el.querySelector('.avatar-circle').textContent = initials(data.username || 'U');
    }
  }

  // --- Render group in sidebar ---
  function renderGroup(gid, data) {
    let el = document.getElementById('group-' + gid);
    if (!el) {
      el = document.createElement('div');
      el.className = 'list-item';
      el.id = 'group-' + gid;
      el.tabIndex = 0;

      const av = document.createElement('div');
      av.className = 'avatar-circle';
      av.style.background = colorFromString(data.name || gid);
      av.textContent = initials(data.name || 'G');

      const info = document.createElement('div');
      info.className = 'item-info';
      const name = document.createElement('div');
      name.className = 'item-name';
      name.textContent = data.name || '–ë–µ–∑ –∏–º–µ–Ω–∏';
      const status = document.createElement('div');
      status.className = 'item-status';
      status.textContent = data.description || '–ì—Ä—É–ø–ø–∞';

      info.appendChild(name);
      info.appendChild(status);

      el.appendChild(av);
      el.appendChild(info);

      el.addEventListener('click', () => openChat('group', gid, data.name || '–ë–µ–∑ –∏–º–µ–Ω–∏'));
      el.addEventListener('keypress', e => { if (e.key === 'Enter') el.click(); });

      groupsList.appendChild(el);
    } else {
      // Update name or description
      el.querySelector('.item-name').textContent = data.name || '–ë–µ–∑ –∏–º–µ–Ω–∏';
      el.querySelector('.item-status').textContent = data.description || '–ì—Ä—É–ø–ø–∞';
      el.querySelector('.avatar-circle').style.background = colorFromString(data.name || gid);
      el.querySelector('.avatar-circle').textContent = initials(data.name || 'G');
    }
  }

  // --- Open chat ---
  function openChat(type, id, name) {
    currentChat = { type, id, name };
    // Highlight active in sidebar
    document.querySelectorAll('.list-item').forEach(item => item.classList.remove('active'));
    const sel = (type === 'user' ? '#user-' : '#group-') + id;
    const activeItem = document.querySelector(sel);
    if (activeItem) activeItem.classList.add('active');

    chatHeader.textContent = name;
    chatWrapper.classList.add('show');
    chatWrapper.classList.remove('hidden');
    scrollToBottom();

    // Clear messages and load chat
    messagesEl.innerHTML = '';
    loadMessages(type, id);
  }

  // --- Listen for messages ---
  let messagesListener = null;
  function loadMessages(type, id) {
    if (messagesListener) messagesListener(); // off previous listener
    const chatPath = type === 'user'
      ? `messages/privateChats/${getPrivateChatId(currentUser.uid, id)}`
      : `messages/groupChats/${id}`;
    const chatRef = ref(db, chatPath);

    onValue(chatRef, snapshot => {
      messagesEl.innerHTML = '';
      const val = snapshot.val() || {};
      const msgs = Object.entries(val).sort((a,b) => a[1].timestamp - b[1].timestamp);
      msgs.forEach(([msgId, msg]) => {
        addMessageToChat(msg, msgId);
      });
      scrollToBottom();
    });
  }

  // --- Add message to chat DOM ---
  function addMessageToChat(msg, id) {
    const mine = msg.sender === currentUser.uid;
    const msgEl = el('div', 'message' + (mine ? ' mine' : ''));
    msgEl.id = 'msg-' + id;

    // Meta (avatar + author + time)
    const meta = el('div', 'meta');
    const avatar = el('div', 'avatar-sm');
    avatar.style.background = colorFromString(msg.senderName || msg.sender);
    avatar.textContent = initials(msg.senderName || 'U');
    const author = el('div', 'author', mine ? '–í—ã' : msg.senderName || '–ë–µ–∑ –∏–º–µ–Ω–∏');
    const time = el('div', 'time', timeString(msg.timestamp || Date.now()));
    meta.appendChild(avatar);
    meta.appendChild(author);
    meta.appendChild(time);

    msgEl.appendChild(meta);

    // Text or image
    if (msg.text) {
      const txt = el('div', 'msg-text', msg.text);
      msgEl.appendChild(txt);
    }
    if (msg.imageUrl) {
      const img = document.createElement('img');
      img.className = 'msg-img';
      img.src = msg.imageUrl;
      img.alt = '–ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ';
      msgEl.appendChild(img);
    }

    messagesEl.appendChild(msgEl);
  }

  // --- Compose message and send ---
  async function sendMessage() {
    const text = textInput.value.trim();
    if (!text && !fileInput.files.length) return;

    const chatPath = currentChat.type === 'user'
      ? `messages/privateChats/${getPrivateChatId(currentUser.uid, currentChat.id)}`
      : `messages/groupChats/${currentChat.id}`;

    const chatRef = ref(db, chatPath);

    const newMsgRef = push(chatRef);

    let imageUrl = null;
    if (fileInput.files.length > 0) {
      const file = fileInput.files[0];
      const fileRef = storageRef(storage, `chatImages/${currentUser.uid}_${Date.now()}_${file.name}`);
      await uploadBytes(fileRef, file);
      imageUrl = await getDownloadURL(fileRef);
      fileInput.value = '';
    }

    await set(newMsgRef, {
      sender: currentUser.uid,
      senderName: currentUser.displayName || currentUser.email,
      text: text || null,
      imageUrl: imageUrl,
      timestamp: Date.now(),
    });

    textInput.value = '';
    scrollToBottom();
  }

  // --- Helpers ---
  // Private chat ID between two users (sorted by uid)
  function getPrivateChatId(uid1, uid2) {
    return [uid1, uid2].sort().join('_');
  }

  // --- UI for login/registration ---

  async function promptLogin() {
    const email = prompt("–í–≤–µ–¥–∏—Ç–µ email");
    if (!email) return;
    const password = prompt("–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å");
    if (!password) return;

    try {
      await signInWithEmailAndPassword(auth, email, password);
      // –£—Å–ø–µ—Ö ‚Äî onAuthStateChanged —Å—Ä–∞–±–æ—Ç–∞–µ—Ç
    } catch (err) {
      if (err.code === 'auth/user-not-found') {
        // –ü–æ–ø—ã—Ç–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
        if (confirm("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω. –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç?")) {
          try {
            const cred = await createUserWithEmailAndPassword(auth, email, password);
            // –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –º–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å displayName:
            const name = prompt("–í–≤–µ–¥–∏—Ç–µ –∏–º—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –≤ —á–∞—Ç–µ") || email.split('@')[0];
            await updateProfile(cred.user, { displayName: name });
          } catch(e2) {
            alert('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + e2.message);
            promptLogin();
          }
        } else {
          promptLogin();
        }
      } else {
        alert('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + err.message);
        promptLogin();
      }
    }
  }

  // --- Show current user info ---
  function showUserInfo(user) {
    userInfo.innerHTML = '';

    const avatar = el('div', 'avatar-circle');
    avatar.textContent = initials(user.displayName || user.email);

    const name = el('div', null, user.displayName || user.email);

    const logoutBtn = el('button', null, '–í—ã–π—Ç–∏');
    logoutBtn.id = 'logoutBtn';
    logoutBtn.onclick = () => signOut(auth);

    const wrapper = document.createElement('div');
    wrapper.style.display = 'flex';
    wrapper.style.alignItems = 'center';
    wrapper.style.gap = '12px';
    wrapper.appendChild(avatar);
    wrapper.appendChild(name);
    wrapper.appendChild(logoutBtn);

    userInfo.appendChild(wrapper);
  }

  // --- Load users from DB ---
  function loadUsers() {
    const usersRef = ref(db, 'users');
    onValue(usersRef, snapshot => {
      const users = snapshot.val() || {};
      usersList.innerHTML = '';
      Object.entries(users).forEach(([uid, data]) => {
        if (uid === currentUser.uid) return; // –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å–µ–±—è
        renderUser(uid, data);
      });
    });
  }

  // --- Load groups from DB ---
  function loadGroups() {
    const groupsRef = ref(db, 'groups');
    onValue(groupsRef, snapshot => {
      const groups = snapshot.val() || {};
      groupsList.innerHTML = '';
      Object.entries(groups).forEach(([gid, data]) => {
        renderGroup(gid, data);
      });
    });
  }

  // --- Set user online status ---
  function setUserOnlineStatus(uid, online) {
    const statusRef = ref(db, `users/${uid}/online`);
    set(statusRef, online);
  }

  // --- Init user presence ---
  function initUserPresence(uid) {
    const userStatusRef = ref(db, `users/${uid}/online`);
    set(userStatusRef, true);
    onDisconnect(userStatusRef).set(false);
  }

  // --- Toggle chat panel on small screens ---
  chatToggleBtn.addEventListener('click', () => {
    if (chatWrapper.classList.contains('show')) {
      chatWrapper.classList.remove('show');
      chatWrapper.classList.add('hidden');
    } else {
      chatWrapper.classList.remove('hidden');
      chatWrapper.classList.add('show');
      if (!currentChat) {
        chatHeader.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç —Å–ª–µ–≤–∞';
        messagesEl.innerHTML = '';
      }
    }
  });

  // --- Send message on button or enter ---
  sendBtn.addEventListener('click', sendMessage);
  textInput.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  // --- On file attach ---
  fileInput.addEventListener('change', () => {
    if (fileInput.files.length > 0) {
      sendMessage();
    }
  });

  // --- Auth state listener ---
  onAuthStateChanged(auth, user => {
    if (user) {
      currentUser = user;
      showUserInfo(user);

      // Add user to DB if not exists
      const userRef = ref(db, 'users/' + user.uid);
      get(userRef).then(snap => {
        if (!snap.exists()) {
          set(userRef, {
            username: user.displayName || user.email,
            email: user.email,
            online: true,
            createdAt: Date.now()
          });
        } else {
          set(userRef.child('online'), true);
        }
      });

      initUserPresence(user.uid);

      loadUsers();
      loadGroups();

      chatToggleBtn.style.display = 'flex';
      chatWrapper.classList.remove('hidden');

    } else {
      currentUser = null;
      usersList.innerHTML = '';
      groupsList.innerHTML = '';
      messagesEl.innerHTML = '';
      chatHeader.textContent = '–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —á–∞—Ç';
      userInfo.innerHTML = '';
      chatToggleBtn.style.display = 'none';
      chatWrapper.classList.add('hidden');
      promptLogin();
    }
  });

  // --- Init ---
  chatToggleBtn.style.display = 'none';
  chatWrapper.classList.add('hidden');

  // –°–æ–∑–¥–∞–µ–º –ø–∞—Ä—É –≥—Ä—É–ø–ø –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞ (–µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç)
  async function createExampleGroups() {
    const groupsRef = ref(db, 'groups');
    const snapshot = await get(groupsRef);
    if (!snapshot.exists()) {
      const group1 = push(groupsRef);
      const group2 = push(groupsRef);
      await set(group1, { name: '–û–±—â–∏–π —á–∞—Ç', description: '–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏' });
      await set(group2, { name: '–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞', description: '–û–±—Å—É–∂–¥–∞–µ–º –ø—Ä–æ–µ–∫—Ç—ã' });
    }
  }
  createExampleGroups();

</script>
</body>
    <div id="frame" style="
  width: 320px;
  max-width: 90%;
  margin: 8px auto;
  background: rgba(0, 0, 0, 0.5);
  position: relative;
  z-index: 99998;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 0 8px rgba(0,0,0,0.4);
">
  <iframe data-aa="2406373" src="//acceptable.a-ads.com/2406373/?size=320x50&background_color=ddd&title_color=b27&title_hover_color=fffefe"
    style="border:0; width:100%; height:50px; display:block;"
    scrolling="no" 
    allowtransparency="true" 
    frameborder="0" 
    marginwidth="0" 
    marginheight="0">
  </iframe>
</div>
</html>
