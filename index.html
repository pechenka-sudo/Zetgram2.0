<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ZetGram ‚Äî Chat —Å –õ–° –∏ –≥—Ä—É–ø–ø–∞–º–∏</title>

<!-- –°—Ç–∏–ª–∏ -->
<style>
:root{
  --bg:#1a0000; --panel:#2a0f0f; --accent:#b30000; --accent-2:#ff4c4c; --muted:#ff9999;
  --glass: rgba(255,255,255,0.03);
  --nice: #ffefef;
}
*{box-sizing:border-box}
html,body{height:100%; margin:0; font-family: Inter,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--nice); -webkit-font-smoothing:antialiased}
.app{
  height:100vh; display:flex; flex-direction:column;
}
/* header */
.header{
  display:flex; align-items:center; justify-content:space-between;
  padding:12px 16px; background:linear-gradient(90deg,var(--accent),#7e0000);
  box-shadow: 0 3px 10px rgba(0,0,0,0.5);
}
.header .title{font-weight:700; font-size:18px}
.header .user-info{display:flex; gap:10px; align-items:center}

/* layout */
.container{
  flex:1; display:flex; gap:12px; padding:12px;
}
/* sidebar users */
.sidebar{
  width:220px; max-width:30%;
  background:var(--panel); border-radius:12px; padding:12px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.4);
  display:flex; flex-direction:column;
  overflow-y:auto;
}
.sidebar h3{margin:0 0 10px 0; color:var(--accent-2)}
.users-list{overflow:auto; flex:1; display:flex; flex-direction:column; gap:8px; padding-right:6px}
.user-row{display:flex; gap:8px; align-items:center; padding:8px; border-radius:8px; cursor:default}
.user-row .avatar{width:40px;height:40px;border-radius:8px; display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff}
.user-row .meta{display:flex;flex-direction:column}
.user-row .meta .name{font-weight:600}
.user-row .status{font-size:12px; color:var(--muted)}

/* main chat panel */
.panel{
  flex:1; display:flex; flex-direction:column; border-radius:12px; background: linear-gradient(180deg,#240606,#2a0f0f);
  padding:10px; box-shadow: 0 8px 30px rgba(0,0,0,0.6);
  min-width:320px;
  overflow: hidden;
}

/* message area */
.messages{
  flex:1; overflow-y:auto; padding:12px; display:flex; flex-direction:column; gap:10px;
  scroll-behavior:smooth;
}
.message{
  max-width:72%; padding:10px 12px; border-radius:12px; position:relative;
  box-shadow: 0 4px 12px rgba(0,0,0,0.4);
  word-break:break-word; background: #4a0a0a;
  user-select: text;
}
.message.mine{align-self:flex-end; background: linear-gradient(180deg,var(--accent),#8b0000)}
.message .meta{display:flex; gap:8px; align-items:center; margin-bottom:6px}
.avatar-sm{width:36px;height:36px;border-radius:8px;display:inline-flex;align-items:center;justify-content:center;font-weight:700;color:white}
.author{font-weight:700; color:var(--accent-2)}
.time{font-size:12px;color:var(--muted); margin-left:6px}
.msg-text{font-size:15px; margin-bottom:6px}
.msg-img{display:block; max-width:320px; border-radius:8px; margin-top:6px; box-shadow: 0 6px 16px rgba(0,0,0,0.5)}

/* delete button */
.del-btn{position:absolute; top:6px; right:6px; background:transparent; border:none; color:var(--muted); font-weight:700; cursor:pointer}

/* input area fixed bottom inside panel */
.input-bar{
  display:flex; gap:8px; align-items:center; margin-top:8px; padding-top:8px; border-top:1px solid rgba(255,0,0,0.06)
}
.input-field{
  flex:1; display:flex; gap:8px; align-items:center; background:var(--glass); padding:8px; border-radius:10px;
}
textarea{flex:1; resize:none; padding:8px; border-radius:8px; background:transparent; border:none; color:var(--nice); outline:none; font-size:15px}
.file-btn{background:transparent; border:2px dashed rgba(255,255,255,0.06); padding:6px;border-radius:8px; color:var(--muted); cursor:pointer}
.send-btn{background:linear-gradient(90deg,var(--accent),#ff3b3b); border:none; color:white; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:700}

/* select & recipient input */
#msgType {
  background: var(--glass);
  color: var(--nice);
  border-radius: 8px;
  border: none;
  padding: 6px 10px;
  font-size: 15px;
  cursor: pointer;
  user-select: none;
}
#recipientInput {
  background: var(--glass);
  color: var(--nice);
  border-radius: 8px;
  border: none;
  padding: 6px 10px;
  font-size: 15px;
  outline: none;
}

/* —Ä–µ–∫–ª–∞–º–Ω—ã–π –±–ª–æ–∫ */
#adBanner {
  position: fixed;
  bottom: 12px;
  right: 12px;
  width: 250px;
  background: rgba(0,0,0,0.7);
  border-radius: 12px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.7);
  z-index: 99999;
  overflow: hidden;
}
#adBanner iframe {
  width: 100%;
  height: 90px;
  border: none;
  display: block;
}
#adBanner .close {
  position: absolute;
  top: 6px;
  right: 10px;
  color: var(--muted);
  font-weight: 700;
  cursor: pointer;
  user-select: none;
  font-size: 18px;
}

/* responsive */
@media(max-width:880px){
  .container{padding:8px; flex-direction: column;}
  .sidebar{display:none}
  .panel{min-width:0; flex:1;}
  .input-field {flex-wrap: wrap; gap:4px;}
  #recipientInput {width: 100%; margin-top: 4px;}
  #msgType {width: 100%;}
  #adBanner {width: 100%; bottom: 0; right: 0; border-radius: 0;}
}
</style>
</head>
<body>
<div class="app" role="application" aria-label="ZetGram chat">
  <div class="header" role="banner">
    <div class="title">ZetGram üî¥</div>
    <div class="user-info" id="headerUser" tabindex="0" aria-label="–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ">
      <!-- logged user -->
    </div>
  </div>

  <div class="container">
    <div class="sidebar" aria-label="–°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π">
      <h3>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h3>
      <div class="users-list" id="usersList"></div>
      <div style="margin-top:8px; text-align:center; color:var(--muted); font-size:13px">–û–Ω–ª–∞–π–Ω/–≤ —Å–µ—Ç–∏</div>
    </div>

    <div class="panel" role="main" aria-live="polite" aria-relevant="additions">
      <div class="messages" id="messages"></div>

      <div class="input-bar" role="region" aria-label="–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è">
        <div class="input-field">
          <select id="msgType" title="–¢–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è" aria-label="–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è">
            <option value="general">–û–±—â–∏–π —á–∞—Ç</option>
            <option value="private">–õ–∏—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</option>
            <option value="group">–ì—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç</option>
          </select>
          
          <input id="recipientInput" type="text" placeholder="–ü–æ–ª—É—á–∞—Ç–µ–ª—å (–Ω–∏–∫ –∏–ª–∏ –≥—Ä—É–ø–ø–∞)" aria-label="–ü–æ–ª—É—á–∞—Ç–µ–ª—å —Å–æ–æ–±—â–µ–Ω–∏—è" style="display:none" />

          <textarea id="textInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (Enter ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å, Shift+Enter ‚Äî –Ω–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞)" aria-multiline="true"></textarea>
          <input id="fileInput" class="file-btn" type="file" accept="image/*" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ" aria-label="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ" />
        </div>
        <button class="send-btn" id="sendBtn" aria-label="–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <div id="adBanner" aria-hidden="false">
    <div class="close" id="closeAd" aria-label="–ó–∞–∫—Ä—ã—Ç—å —Ä–µ–∫–ª–∞–º—É">√ó</div>
    <iframe data-aa='2406373' src='//acceptable.a-ads.com/2406373/?size=250x90&background_color=1a0000&title_color=b30000&title_hover_color=ff4c4c'></iframe>
  </div>
</div>

<!-- Firebase SDK (modular) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import {
    getAuth,
    signInWithEmailAndPassword,
    createUserWithEmailAndPassword,
    onAuthStateChanged,
    signOut,
    updateProfile
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
  import {
    getDatabase,
    ref,
    push,
    onChildAdded,
    onChildRemoved,
    query,
    orderByChild,
    set,
    onValue,
    remove,
    onDisconnect
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";
  import {
    getStorage,
    ref as storageRef,
    uploadBytes,
    getDownloadURL
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-storage.js";

  // ---------- CONFIG ----------
  const firebaseConfig = {
    apiKey: "AIzaSyDTZrRKHrmKnA9ycBWvt9ephnr7TN6ZFs8",
    authDomain: "zetgram-d2b77.firebaseapp.com",
    databaseURL: "https://zetgram-d2b77-default-rtdb.firebaseio.com",
    projectId: "zetgram-d2b77",
    storageBucket: "zetgram-d2b77.appspot.com",
    messagingSenderId: "804686454",
    appId: "1:804686454:web:db9f618955e3d370deed57",
    measurementId: "G-KCYSRCX4ZL"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);
  const storage = getStorage(app);

  // ---------- UI references ----------
  const messagesEl = document.getElementById('messages');
  const textInput = document.getElementById('textInput');
  const fileInput = document.getElementById('fileInput');
  const sendBtn = document.getElementById('sendBtn');
  const usersListEl = document.getElementById('usersList');
  const headerUser = document.getElementById('headerUser');
  const adBanner = document.getElementById('adBanner');
  const closeAd = document.getElementById('closeAd');
  const msgType = document.getElementById('msgType');
  const recipientInput = document.getElementById('recipientInput');

  // Close ad on click
  closeAd.addEventListener('click', () => adBanner.style.display = 'none');

  // Show/hide recipient input depending on message type
  msgType.addEventListener('change', () => {
    if(msgType.value === 'general'){
      recipientInput.style.display = 'none';
      recipientInput.value = '';
    } else {
      recipientInput.style.display = 'inline-block';
    }
  });

  // --------- small helpers ----------
  function el(tag, cls, txt){
    const e = document.createElement(tag);
    if(cls) e.className = cls;
    if(txt !== undefined) e.textContent = txt;
    return e;
  }
  function timeString(ts){
    const d = new Date(ts);
    return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
  }
  function initials(name){
    if(!name) return '??';
    return name.split(' ').map(s=>s[0]?.toUpperCase()||'').slice(0,2).join('');
  }
  function colorFromString(s){
    let h=0; for(let i=0;i<s.length;i++) h = (h<<5)-h + s.charCodeAt(i);
    const hue = Math.abs(h)%360;
    return `hsl(${hue} 80% 35%)`;
  }

  // ---------- Presence & users ----------
  const displayedUsers = new Map(); // uid->node
  function renderUser(uid, data){
    let row = displayedUsers.get(uid);
    if(!row){
      row = el('div','user-row');
      const av = el('div','avatar');
      av.style.width = '40px'; av.style.height='40px'; av.style.borderRadius='8px'; av.style.display='flex'; av.style.alignItems='center'; av.style.justifyContent='center';
      av.style.fontWeight='700';
      av.style.color='#fff';
      av.style.background = colorFromString(data.username||uid);
      av.textContent = initials(data.username||'U');
      const meta = el('div','meta');
      const name = el('div','name', data.username||'–ë–µ–∑ –∏–º–µ–Ω–∏');
      const status = el('div','status', data.online ? '–æ–Ω–ª–∞–π–Ω' : `–ø–æ—Å–ª–µ–¥–Ω–∏–π: ${data.lastSeen ? new Date(data.lastSeen).toLocaleString() : '‚Äî'}`);
      status.style.color='var(--muted)';
      meta.appendChild(name); meta.appendChild(status);
      row.appendChild(av); row.appendChild(meta);
      usersListEl.appendChild(row);
      displayedUsers.set(uid,row);
    } else {
      // update status
      const name = row.querySelector('.meta .name');
      const status = row.querySelector('.meta .status');
      if(name) name.textContent = data.username||'–ë–µ–∑ –∏–º–µ–Ω–∏';
      if(status) status.textContent = data.online ? '–æ–Ω–ª–∞–π–Ω' : `–ø–æ—Å–ª–µ–¥–Ω–∏–π: ${data.lastSeen ? new Date(data.lastSeen).toLocaleString() : '‚Äî'}`;
    }
  }

  // listen users list
  const usersRef = ref(db, 'users');
  onValue(usersRef, snapshot=>{
    const v = snapshot.val() || {};
    // remove DOM nodes not in v
    const uids = Object.keys(v);
    // render each
    uids.forEach(uid => {
      renderUser(uid, v[uid]);
    });
    // remove old
    for(const [uid,node] of displayedUsers){
      if(!v[uid]) { node.remove(); displayedUsers.delete(uid); }
    }
  });

  // ---------- messages ----------
  const displayedMessages = new Set();
  function scrollToBottom(){
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  // –ü—Ä–æ–≤–µ—Ä–∫–∞, –º–æ–∂–µ—Ç –ª–∏ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–µ—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
  function canSeeMessage(msg) {
    if(msg.type === 'general') return true;
    if(!auth.currentUser) return false;
    const myUid = auth.currentUser.uid;
    const myName = auth.currentUser.displayName || (auth.currentUser.email && auth.currentUser.email.split('@')[0]);

    if(msg.type === 'private'){
      // recipients ‚Äî –º–∞—Å—Å–∏–≤ —Å –æ–¥–Ω–∏–º –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –ø–æ–ª—É—á–∞—Ç–µ–ª—è–º–∏ (–ø–æ –Ω–∏–∫–Ω–µ–π–º—É –∏–ª–∏ uid)
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º, –µ—Å–ª–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å –∏–ª–∏ –ø–æ–ª—É—á–∞—Ç–µ–ª—å
      return msg.uid === myUid || msg.recipients.includes(myUid) || msg.recipients.includes(myName);
    }
    if(msg.type === 'group'){
      // recipients ‚Äî —Å–ø–∏—Å–æ–∫ –≥—Ä—É–ø–ø (–Ω–∞–ø—Ä–∏–º–µ—Ä ['friends','admins'])
      // –î–ª—è –ø—Ä–∏–º–µ—Ä–∞ —Ç—É—Ç –ø—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ hardcoded –≥—Ä—É–ø–ø–∞—Ö
      const userGroups = ['friends']; // –ó–¥–µ—Å—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ª–æ–≥–∏–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –≥—Ä—É–ø–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      return msg.recipients.some(r => userGroups.includes(r));
    }
    return false;
  }

  // render one message
  function renderMessage(key, msg){
    if(displayedMessages.has(key)) return;
    if(!canSeeMessage(msg)) return; // —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –≤–∏–¥–∏–º–æ—Å—Ç–∏

    displayedMessages.add(key);

    const isMine = auth.currentUser && msg.uid === auth.currentUser.uid;
    const wrapper = el('div','message ' + (isMine ? 'mine':'other'));
    wrapper.id = 'm-'+key;

    // meta (avatar + author + time)
    const meta = el('div','meta');
    const av = el('div','avatar-sm');
    av.style.background = colorFromString(msg.author || msg.username || msg.uid);
    av.textContent = initials(msg.author || msg.username || msg.uid);
    const author = el('div','author', msg.author || msg.username || '–ë–µ–∑ –∏–º–µ–Ω–∏');
    const tm = el('div','time', timeString(msg.timestamp||Date.now()));

    // –¢–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ –º–µ—Ç–∫–µ (–ø–æ–¥—Å–∫–∞–∑–∫–∞)
    let typeLabel = '';
    if(msg.type === 'private') typeLabel = '(–õ–°)';
    else if(msg.type === 'group') typeLabel = '(–ì—Ä—É–ø–ø–∞)';
    if(typeLabel) author.textContent += ' ' + typeLabel;

    meta.appendChild(av);
    meta.appendChild(author);
    meta.appendChild(tm);

    const textNode = el('div','msg-text', msg.text || '');

    wrapper.appendChild(meta);
    if(msg.text) wrapper.appendChild(textNode);

    // image (if present)
    if(msg.imageUrl){
      const img = document.createElement('img');
      img.src = msg.imageUrl;
      img.className = 'msg-img';
      img.alt = '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ';
      wrapper.appendChild(img);
      img.addEventListener('load', scrollToBottom);
    }

    // delete button for own
    if(isMine){
      const del = el('button','del-btn','√ó');
      del.title = '–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ';
      del.addEventListener('click', async (ev)=>{
        ev.stopPropagation();
        if(!confirm('–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?')) return;
        try{
          await remove(ref(db, 'messages/' + key));
        }catch(e){ alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: '+e.message) }
      });
      wrapper.appendChild(del);
    }

    messagesEl.appendChild(wrapper);
    scrollToBottom();
  }

  // listen messages
  const messagesRef = ref(db, 'messages');
  onChildAdded(messagesRef, snapshot=>{
    const msg = snapshot.val();
    if(!msg) return;
    renderMessage(snapshot.key, msg);
  });
  onChildRemoved(messagesRef, snapshot=>{
    const key = snapshot.key;
    if(!key) return;
    displayedMessages.delete(key);
    const node = document.getElementById('m-'+key);
    if(node) node.remove();
  });

  // ---------- send message ----------
  async function sendMessage(text, imageUrl=null){
    if(!auth.currentUser) { alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ'); return; }
    const type = msgType.value; // general, private, group
    let recipients = [];

    if(type === 'private' || type === 'group'){
      const rec = recipientInput.value.trim();
      if(!rec){
        alert('–í–≤–µ–¥–∏—Ç–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è –¥–ª—è –ª–∏—á–Ω–æ–≥–æ –∏–ª–∏ –≥—Ä—É–ø–ø–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è');
        return;
      }
      // –†–∞–∑–¥–µ–ª–∏–º –ø–æ –∑–∞–ø—è—Ç—ã–º ‚Äî –º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º
      recipients = rec.split(',').map(s => s.trim()).filter(s => s.length > 0);
      if(recipients.length === 0){
        alert('–ù–µ–≤–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π');
        return;
      }
    }

    const msg = {
      uid: auth.currentUser.uid,
      author: auth.currentUser.displayName || (auth.currentUser.email && auth.currentUser.email.split('@')[0]) || '–ë–µ–∑ –∏–º–µ–Ω–∏',
      text: text || '',
      imageUrl: imageUrl || null,
      timestamp: Date.now(),
      type: type,
      recipients: recipients,
    };

    await push(ref(db, 'messages'), msg);
  }

  sendBtn.addEventListener('click', ()=>{
    const text = textInput.value.trim();
    if(!text && !fileInput.files.length) return alert('–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
    if(fileInput.files.length){
      uploadImageAndSend(fileInput.files[0], text);
    } else {
      sendMessage(text).then(()=>{
        textInput.value = '';
      });
    }
  });

  textInput.addEventListener('keydown', e=>{
    if(e.key === 'Enter' && !e.shiftKey){
      e.preventDefault();
      sendBtn.click();
    }
  });

  async function uploadImageAndSend(file, text){
    if(!auth.currentUser) { alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ'); return; }
    try{
      const path = 'images/' + auth.currentUser.uid + '/' + Date.now() + '-' + file.name;
      const sref = storageRef(storage, path);
      await uploadBytes(sref, file);
      const url = await getDownloadURL(sref);
      await sendMessage(text, url);
      textInput.value = '';
      fileInput.value = '';
    }catch(e){
      alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞: '+e.message);
    }
  }

  // ---------- simple login UI ----------
  async function promptLogin(){
    const email = prompt('–í–≤–µ–¥–∏—Ç–µ email');
    if(!email) return;
    const password = prompt('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å');
    if(!password) return;
    try{
      await signInWithEmailAndPassword(auth, email, password);
    }catch(e){
      if(e.code === 'auth/user-not-found'){
        if(confirm('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è?')){
          try{
            const cred = await createUserWithEmailAndPassword(auth, email, password);
            // –ó–∞–ø—Ä–æ—Å –∏–º–µ–Ω–∏
            let username = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫–Ω–µ–π–º (–æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è)', email.split('@')[0]) || email.split('@')[0];
            await updateProfile(cred.user, {displayName: username});
            // –î–æ–±–∞–≤–∏–º –≤ users –≤ –±–∞–∑—É
            await set(ref(db, 'users/' + cred.user.uid), {username: username, online: true, lastSeen: Date.now()});
          }catch(er){ alert('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + er.message); }
        }
      } else alert('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: '+e.message);
    }
  }

  function updateUserStatus(user){
    if(!user) {
      headerUser.textContent = '–ì–æ—Å—Ç—å (–Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω)';
      return;
    }
    headerUser.textContent = `–í—ã: ${user.displayName || user.email || user.uid}  ‚Äî <button id="logoutBtn">–í—ã–π—Ç–∏</button>`;
    const logoutBtn = document.getElementById('logoutBtn');
    if(logoutBtn){
      logoutBtn.addEventListener('click', ()=>signOut(auth));
    }
    // –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å online –≤ –±–∞–∑–µ
    const uRef = ref(db, 'users/' + user.uid);
    set(uRef, {username: user.displayName || user.email?.split('@')[0] || '–ë–µ–∑ –∏–º–µ–Ω–∏', online: true, lastSeen: Date.now()});
    onDisconnect(uRef).update({online: false, lastSeen: Date.now()});
  }

  onAuthStateChanged(auth, user=>{
    updateUserStatus(user);
    if(!user){
      setTimeout(promptLogin, 100); // –ó–∞–ø—Ä–æ—Å –ª–æ–≥–∏–Ω–∞
    }
  });

</script>
</body>
  <div id="frame" style="
  width: 320px;
  max-width: 90%;
  margin: 8px auto;
  background: rgba(0, 0, 0, 0.5);
  position: relative;
  z-index: 99998;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 0 8px rgba(0,0,0,0.4);
">
  <iframe data-aa="2406373" src="//acceptable.a-ads.com/2406373/?size=320x50&background_color=ddd&title_color=b27&title_hover_color=fffefe"
    style="border:0; width:100%; height:50px; display:block;"
    scrolling="no" 
    allowtransparency="true" 
    frameborder="0" 
    marginwidth="0" 
    marginheight="0">
  </iframe>
</div>

</html>
