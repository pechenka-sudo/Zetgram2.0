<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ZetGram ‚Äî Chat —Å –ê–¥–º–∏–Ω–∫–æ–π –∏ –ö–æ–º–∞–Ω–¥–∞–º–∏</title>

<style>
:root{
  --bg:#1a0000; --panel:#2a0f0f; --accent:#b30000; --accent-2:#ff4c4c; --muted:#ff9999;
  --glass: rgba(255,255,255,0.03);
  --nice: #ffefef;
}
*{box-sizing:border-box}
html,body{height:100%; margin:0; font-family: Inter,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--nice); -webkit-font-smoothing:antialiased}
.app{
  height:100vh; display:flex; flex-direction:column;
}
.header{
  display:flex; align-items:center; justify-content:space-between;
  padding:12px 16px; background:linear-gradient(90deg,var(--accent),#7e0000);
  box-shadow: 0 3px 10px rgba(0,0,0,0.5);
  user-select:none;
}
.header .title{font-weight:700; font-size:18px}
.header .user-info{display:flex; gap:10px; align-items:center; cursor:pointer; user-select:none;}
.header .user-info:hover{opacity:0.8;}

/* layout */
.container{
  flex:1; display:flex; gap:12px; padding:12px;
}
/* sidebar users */
.sidebar{
  width:220px; max-width:30%;
  background:var(--panel); border-radius:12px; padding:12px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.4);
  display:flex; flex-direction:column;
}
.sidebar h3{margin:0 0 10px 0; color:var(--accent-2); user-select:none;}
.users-list{overflow:auto; flex:1; display:flex; flex-direction:column; gap:8px; padding-right:6px;}
.user-row{
  display:flex; gap:8px; align-items:center; padding:8px; border-radius:8px;
  cursor:pointer; transition: background-color 0.2s ease;
}
.user-row:hover{
  background:rgba(179,0,0,0.3);
}
.user-row .avatar{
  width:40px;height:40px;border-radius:8px; display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff;
  user-select:none;
}
.user-row .meta{display:flex;flex-direction:column; user-select:none;}
.user-row .meta .name{font-weight:600}
.user-row .status{font-size:12px; color:var(--muted)}

/* main chat panel */
.panel{
  flex:1; display:flex; flex-direction:column; border-radius:12px; background: linear-gradient(180deg,#240606,#2a0f0f);
  padding:10px; box-shadow: 0 8px 30px rgba(0,0,0,0.6);
  min-width:320px;
}

/* message area */
.messages{
  flex:1; overflow:auto; padding:12px; display:flex; flex-direction:column; gap:10px;
  scroll-behavior:smooth;
}
.message{
  max-width:72%; padding:10px 12px; border-radius:12px; position:relative;
  box-shadow: 0 4px 12px rgba(0,0,0,0.4);
  word-break:break-word; background: #4a0a0a;
}
.message.mine{align-self:flex-end; background: linear-gradient(180deg,var(--accent),#8b0000)}
.message.console{
  align-self: center; background: linear-gradient(90deg, #660000, #b30000);
  font-weight: 700; color: #fff;
  max-width: 90%;
  text-align: center;
}
.message .meta{display:flex; gap:8px; align-items:center; margin-bottom:6px}
.avatar-sm{width:36px;height:36px;border-radius:8px;display:inline-flex;align-items:center;justify-content:center;font-weight:700;color:white}
.author{font-weight:700; color:var(--accent-2)}
.time{font-size:12px;color:var(--muted); margin-left:6px}
.msg-text{font-size:15px; margin-bottom:6px}
.msg-img{display:block; max-width:320px; border-radius:8px; margin-top:6px; box-shadow: 0 6px 16px rgba(0,0,0,0.5)}

/* delete button */
.del-btn{position:absolute; top:6px; right:6px; background:transparent; border:none; color:var(--muted); font-weight:700; cursor:pointer}

/* input area fixed bottom inside panel */
.input-bar{
  display:flex; gap:8px; align-items:center; margin-top:8px; padding-top:8px; border-top:1px solid rgba(255,0,0,0.06);
}
.input-field{
  flex:1; display:flex; gap:8px; align-items:center; background:var(--glass); padding:8px; border-radius:10px;
}
textarea{
  flex:1; resize:none; padding:8px; border-radius:8px; background:transparent; border:none; color:var(--nice); outline:none; font-size:15px;
}
.file-btn{
  background:transparent; border:2px dashed rgba(255,255,255,0.06); padding:6px;border-radius:8px; color:var(--muted); cursor:pointer;
}
.send-btn{
  background:linear-gradient(90deg,var(--accent),#ff3b3b); border:none; color:white; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:700;
}

/* Right bottom button to open console or close */
#consoleToggle {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: var(--accent);
  border-radius: 50%;
  width: 50px;
  height: 50px;
  font-size: 26px;
  color: white;
  border: none;
  cursor: pointer;
  box-shadow: 0 0 10px var(--accent);
  z-index: 1100;
}
#consolePanel {
  position: fixed;
  bottom: 80px;
  right: 20px;
  width: 320px;
  max-height: 400px;
  background: var(--panel);
  border-radius: 12px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.7);
  padding: 12px;
  display: none;
  flex-direction: column;
  z-index: 1100;
  color: var(--nice);
}
#consolePanel textarea {
  width: 100%;
  height: 100px;
  background: var(--glass);
  border: none;
  border-radius: 8px;
  color: var(--nice);
  padding: 8px;
  resize: none;
  font-family: monospace;
}
#consolePanel button {
  margin-top: 8px;
  background: var(--accent);
  border: none;
  border-radius: 8px;
  color: white;
  padding: 8px;
  cursor: pointer;
  font-weight: 700;
}

/* Responsive - –º–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è */
@media(max-width: 768px){
  .container{
    flex-direction: column;
    padding: 8px;
  }
  .sidebar{
    display: none;
  }
  .panel{
    min-width: 100%;
    border-radius: 0;
    box-shadow: none;
  }
  .messages{
    margin-bottom: 60px; /* —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–ª–æ –ø–æ–ª–µ –≤–≤–æ–¥–∞ */
  }
  .input-bar{
    position: fixed;
    bottom: 0;
    left: 0; right: 0;
    background: var(--panel);
    padding: 8px;
    box-shadow: 0 -4px 10px rgba(0,0,0,0.5);
    border-top: 1px solid var(--accent);
    z-index: 1000;
  }
  .input-field{
    padding: 8px;
  }
  textarea{
    min-height: 36px;
    font-size: 16px;
  }
  .send-btn{
    padding: 12px 16px;
    font-size: 17px;
    border-radius: 12px;
  }
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è –∑–∞–±–∞–Ω–µ–Ω–Ω—ã—Ö/–∑–∞–º—É—á–µ–Ω–Ω—ã—Ö */
.banned {
  opacity: 0.5;
  pointer-events: none;
}
</style>
</head>
<body>

<div class="app" role="application" aria-label="ZetGram —á–∞—Ç">
  <div class="header" role="banner">
    <div class="title">ZetGram üî¥</div>
    <div class="user-info" id="headerUser" title="–î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ ‚Äî –≤—ã–π—Ç–∏"></div>
  </div>

  <div class="container">
    <div class="sidebar" aria-label="–°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π">
      <h3>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h3>
      <div class="users-list" id="usersList"></div>
      <div style="margin-top:8px; text-align:center; color:var(--muted); font-size:13px">–û–Ω–ª–∞–π–Ω / –í —Å–µ—Ç–∏</div>
    </div>

    <div class="panel" role="main" aria-live="polite">
      <div class="messages" id="messages"></div>
      <div class="input-bar" role="region" aria-label="–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è">
        <div class="input-field">
          <textarea id="textInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (Enter ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å, Shift+Enter ‚Äî –Ω–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞)"></textarea>
        </div>
        <button class="send-btn" id="sendBtn" aria-label="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è/–∑–∞–∫—Ä—ã—Ç–∏—è –∫–æ–Ω—Å–æ–ª–∏ -->
  <button id="consoleToggle" title="–ê–¥–º–∏–Ω—Å–∫–∞—è –∫–æ–Ω—Å–æ–ª—å" style="display:none;">‚öôÔ∏è</button>

  <!-- –ü–∞–Ω–µ–ª—å –∫–æ–Ω—Å–æ–ª–∏ -->
  <div id="consolePanel">
    <div style="font-weight:700; margin-bottom:8px; color:var(--accent-2)">–ê–¥–º–∏–Ω—Å–∫–∞—è –∫–æ–Ω—Å–æ–ª—å</div>
    <textarea id="consoleInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É: /mute, /ban, /say ..."></textarea>
    <button id="consoleSend">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
  </div>

</div>

<!-- Firebase SDK (modular) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import {
    getAuth,
    signInWithEmailAndPassword,
    createUserWithEmailAndPassword,
    onAuthStateChanged,
    signOut,
    updateProfile
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
  import {
    getDatabase,
    ref,
    push,
    onChildAdded,
    onChildRemoved,
    query,
    orderByChild,
    set,
    serverTimestamp,
    onValue,
    remove,
    onDisconnect,
    get
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

  // --- –ö–æ–Ω—Ñ–∏–≥ Firebase (–∑–∞–º–µ–Ω–∏ –Ω–∞ —Å–≤–æ–π) ---
  const firebaseConfig = {
    apiKey: "AIzaSyDTZrRKHrmKnA9ycBWvt9ephnr7TN6ZFs8",
    authDomain: "zetgram-d2b77.firebaseapp.com",
    databaseURL: "https://zetgram-d2b77-default-rtdb.firebaseio.com",
    projectId: "zetgram-d2b77",
    storageBucket: "zetgram-d2b77.appspot.com",
    messagingSenderId: "804686454",
    appId: "1:804686454:web:db9f618955e3d370deed57",
    measurementId: "G-KCYSRCX4ZL"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  // --- UI ---
  const messagesEl = document.getElementById('messages');
  const textInput = document.getElementById('textInput');
  const sendBtn = document.getElementById('sendBtn');
  const usersListEl = document.getElementById('usersList');
  const headerUser = document.getElementById('headerUser');

  const consoleToggle = document.getElementById('consoleToggle');
  const consolePanel = document.getElementById('consolePanel');
  const consoleInput = document.getElementById('consoleInput');
  const consoleSend = document.getElementById('consoleSend');

  // --- –ê–¥–º–∏–Ω—Å–∫–∏–µ –Ω–∏–∫–∏/–µ–º–µ–π–ª—ã ---
  // –¢–µ–±–µ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å—é–¥–∞ —Å–≤–æ–∏—Ö –∞–¥–º–∏–Ω–æ–≤
  // –í —ç—Ç–æ–º –ø—Ä–∏–º–µ—Ä–µ –∞–¥–º–∏–Ω ‚Äî nick = "pechenka", email = "kalysmuhamedzanov@gmail.com"
  const ADMINS = new Set([
    "pechenka",
    "kalysmuhamedzanov@gmail.com"
  ]);

  // --- –°–æ—Å—Ç–æ—è–Ω–∏—è ---
  let currentUser = null;
  let mutedUsers = {}; // uid => timestamp –æ–∫–æ–Ω—á–∞–Ω–∏—è –º—É—Ç–∞
  let bannedUsers = new Set(); // uid –∑–∞–±–∞–Ω–µ–Ω–Ω—ã—Ö
  let onlineUsers = new Map(); // uid -> data

  // --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ---
  function el(tag, cls, txt){
    const e = document.createElement(tag);
    if(cls) e.className = cls;
    if(txt !== undefined) e.textContent = txt;
    return e;
  }
  function timeString(ts){
    const d = new Date(ts);
    return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
  }
  function initials(name){
    if(!name) return '??';
    return name.split(' ').map(s=>s[0]?.toUpperCase()||'').slice(0,2).join('');
  }
  function colorFromString(s){
    let h=0; for(let i=0;i<s.length;i++) h = (h<<5)-h + s.charCodeAt(i);
    const hue = Math.abs(h)%360;
    return `hsl(${hue} 80% 35%)`;
  }

  // --- –†–µ–Ω–¥–µ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π ---
  function renderUser(uid, data){
    // –Ω–µ —Ä–µ–Ω–¥–µ—Ä–∏–º –∑–∞–±–∞–Ω–µ–Ω–Ω—ã—Ö –≤–æ–æ–±—â–µ –≤ —Å–ø–∏—Å–æ–∫
    if(bannedUsers.has(uid)) return;

    let row = usersListEl.querySelector(`[data-uid="${uid}"]`);
    if(!row){
      row = el('div','user-row');
      row.dataset.uid = uid;
      row.addEventListener('click', () => openPrivateChat(uid, data.username));
      const av = el('div','avatar');
      av.style.background = colorFromString(data.username||uid);
      av.textContent = initials(data.username||'U');
      const meta = el('div','meta');
      const name = el('div','name', data.username||'–ë–µ–∑ –∏–º–µ–Ω–∏');
      const status = el('div','status', data.online ? '–æ–Ω–ª–∞–π–Ω' : `–ø–æ—Å–ª–µ–¥–Ω–∏–π: ${data.lastSeen ? new Date(data.lastSeen).toLocaleString() : '‚Äî'}`);
      meta.appendChild(name); meta.appendChild(status);
      row.appendChild(av); row.appendChild(meta);
      usersListEl.appendChild(row);
    } else {
      const name = row.querySelector('.meta .name');
      const status = row.querySelector('.meta .status');
      if(name) name.textContent = data.username||'–ë–µ–∑ –∏–º–µ–Ω–∏';
      if(status) status.textContent = data.online ? '–æ–Ω–ª–∞–π–Ω' : `–ø–æ—Å–ª–µ–¥–Ω–∏–π: ${data.lastSeen ? new Date(data.lastSeen).toLocaleString() : '‚Äî'}`;
    }
  }

  // --- –û—Ç–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ —á–∞—Ç–∞ (–õ–°) ---
  let activeChat = 'general'; // general –∏–ª–∏ uid –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –õ–°
  let activeChatName = '–û–±—â–∏–π —á–∞—Ç';

  function openPrivateChat(uid, username){
    if(uid === 'console') return; // –Ω–µ–ª—å–∑—è –õ–° —Å –∫–æ–Ω—Å–æ–ª—å—é

    activeChat = uid;
    activeChatName = username;
    messagesEl.innerHTML = ''; // –æ—á–∏—Å—Ç–∏—Ç—å
    loadMessagesForChat(uid);
    updateHeaderChat();
  }

  function updateHeaderChat(){
    headerUser.innerHTML = `<div style="display:flex; align-items:center; gap:8px; user-select:none;">
      <div style="width:36px; height:36px; border-radius:8px; background:${colorFromString(activeChatName)}; display:flex; align-items:center; justify-content:center; font-weight:700;">
        ${initials(activeChatName)}
      </div>
      <div style="display:flex; flex-direction:column; text-align:right; color:var(--nice); user-select:none;">
        <div style="font-weight:700;">${activeChatName}</div>
        <div style="font-size:12px; color:var(--muted); cursor:pointer;" title="–î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ ‚Äî –≤—ã–π—Ç–∏" id="headerUserNameSub">–í—ã: ${currentUser?.displayName || currentUser?.email.split('@')[0]}</div>
      </div>
    </div>
    <button id="logoutBtn" style="margin-left: 12px; cursor:pointer; background:var(--accent); border:none; padding:6px 10px; border-radius:8px; font-weight:700; color:#fff;">–í—ã–π—Ç–∏</button>`;

    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –≤—ã—Ö–æ–¥–∞
    document.getElementById('logoutBtn').onclick = () => {
      signOut(auth);
    };
  }

  // --- –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π ---
  let messagesRef = null;
  let messagesListener = null;

  function chatPath(uid) {
    // –æ–±—â–∏–π —á–∞—Ç ‚Äî 'chats/general'
    // –ª—Å ‚Äî 'chats/private/{uid1}_{uid2}' (–æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã)
    if(uid === 'general') return 'chats/general';

    // –ß—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ —Ä–∞–∑–Ω—ã—Ö –∫–ª—é—á–µ–π –¥–ª—è –ø–∞—Ä—ã, –æ—Ç—Å–æ—Ä—Ç–∏—Ä—É–µ–º uids
    let uids = [currentUser.uid, uid].sort();
    return `chats/private/${uids[0]}_${uids[1]}`;
  }

  function loadMessagesForChat(uid){
    if(messagesListener){
      messagesListener();
      messagesListener = null;
    }
    messagesEl.innerHTML = '';

    messagesRef = ref(db, chatPath(uid));

    // —Å–ª—É—à–∞–µ–º –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    const q = query(messagesRef, orderByChild('timestamp'));
    messagesListener = onChildAdded(q, snapshot => {
      const msg = snapshot.val();
      if(!msg) return;

      if(isUserBanned(msg.uid)) return; // –±–∞–Ω - –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è

      // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–º—É—á–µ–Ω –∏ —ç—Ç–æ –æ–Ω –ø–∏—à–µ—Ç ‚Äî —Å–∫—Ä—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
      if(isUserMuted(msg.uid)) return;

      // –ü–æ–∫–∞–∑ —Å–æ–æ–±—â–µ–Ω–∏—è
      renderMessage(msg);
      // –°–∫—Ä–æ–ª–ª –≤–Ω–∏–∑
      messagesEl.scrollTop = messagesEl.scrollHeight;
    });
  }

  // --- –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–Ω/–º—É—Ç ---
  function isUserMuted(uid){
    if(!mutedUsers[uid]) return false;
    const endTs = mutedUsers[uid];
    return (Date.now() < endTs);
  }
  function isUserBanned(uid){
    return bannedUsers.has(uid);
  }

  // --- –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è ---
  function renderMessage(msg){
    const mine = (msg.uid === currentUser.uid);
    const div = el('div','message');
    if(mine) div.classList.add('mine');
    if(msg.fromConsole) div.classList.add('console');

    const meta = el('div','meta');
    const avatar = el('div','avatar-sm');
    avatar.style.background = colorFromString(msg.username||msg.uid);
    avatar.textContent = initials(msg.username||msg.uid);
    const author = el('div','author', msg.fromConsole ? "[console]" : (msg.username || "–ë–µ–∑ –∏–º–µ–Ω–∏"));
    const time = el('div','time', timeString(msg.timestamp));

    meta.appendChild(avatar);
    meta.appendChild(author);
    meta.appendChild(time);

    const text = el('div','msg-text');
    text.innerHTML = escapeHtml(msg.text).replace(/\n/g,'<br>');

    div.appendChild(meta);
    div.appendChild(text);

    // –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–∏—Ç—å –¥–ª—è —Å–≤–æ–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    if(mine && !msg.fromConsole){
      const del = el('button','del-btn','√ó');
      del.title = "–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ";
      del.onclick = () => {
        remove(ref(db, chatPath(activeChat) + '/' + msg.key));
      };
      div.appendChild(del);
    }

    messagesEl.appendChild(div);
  }

  // --- Escape HTML ---
  function escapeHtml(text){
    if(!text) return '';
    return text.replace(/[&<>"']/g, function(m){
      return {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
      }[m];
    });
  }

  // --- –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π ---
  async function sendMessage(text){
    text = text.trim();
    if(!text) return;

    // –ü—Ä–æ–≤–µ—Ä–∫–∏ –±–∞–Ω/–º—É—Ç
    if(isUserBanned(currentUser.uid)){
      alert('–í—ã –∑–∞–±–∞–Ω–µ–Ω—ã –∏ –Ω–µ –º–æ–∂–µ—Ç–µ –ø–∏—Å–∞—Ç—å –≤ —á–∞—Ç.');
      return;
    }
    if(isUserMuted(currentUser.uid)){
      alert('–í—ã –∑–∞–º—É—á–µ–Ω—ã –∏ –Ω–µ –º–æ–∂–µ—Ç–µ –ø–∏—Å–∞—Ç—å –≤ —á–∞—Ç.');
      return;
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–º–∞–Ω–¥ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤)
    if(text.startsWith('/') && isAdmin()){
      await handleCommand(text);
      textInput.value = '';
      return;
    }

    const msgObj = {
      uid: currentUser.uid,
      username: currentUser.displayName || currentUser.email.split('@')[0],
      text,
      timestamp: Date.now(),
      fromConsole: false,
    };
    const newRef = push(ref(db, chatPath(activeChat)));
    msgObj.key = newRef.key;
    await set(newRef, msgObj);

    textInput.value = '';
  }

  // --- –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥ ---
  async function handleCommand(text){
    const parts = text.trim().split(' ');
    const cmd = parts[0].toLowerCase();
    const args = parts.slice(1);

    if(cmd === '/mute'){
      if(args.length < 2){
        sendConsoleMessage('–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /mute <–Ω–∏–∫> <–≤—Ä–µ–º—è_–≤_–º–∏–Ω—É—Ç–∞—Ö>');
        return;
      }
      const [nick, timeStr] = args;
      const timeMin = parseInt(timeStr);
      if(isNaN(timeMin) || timeMin <= 0){
        sendConsoleMessage('–ù–µ–≤–µ—Ä–Ω–æ–µ –≤—Ä–µ–º—è –º—É—Ç–∞');
        return;
      }
      const userToMute = findUserByNick(nick);
      if(!userToMute){
        sendConsoleMessage(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å "${nick}" –Ω–µ –Ω–∞–π–¥–µ–Ω`);
        return;
      }
      mutedUsers[userToMute.uid] = Date.now() + timeMin*60*1000;
      sendConsoleMessage(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å "${nick}" –∑–∞–º—É—á–µ–Ω –Ω–∞ ${timeMin} –º–∏–Ω—É—Ç.`);
    } else if(cmd === '/ban'){
      if(args.length < 1){
        sendConsoleMessage('–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /ban <–Ω–∏–∫>');
        return;
      }
      const nick = args[0];
      const userToBan = findUserByNick(nick);
      if(!userToBan){
        sendConsoleMessage(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å "${nick}" –Ω–µ –Ω–∞–π–¥–µ–Ω`);
        return;
      }
      bannedUsers.add(userToBan.uid);
      // –ú–æ–∂–Ω–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ —É–¥–∞–ª—è—Ç—å –∏–∑ –æ–Ω–ª–∞–π–Ω –∏ –∏–∑ –±–∞–∑—ã, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
      sendConsoleMessage(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å "${nick}" –∑–∞–±–∞–Ω–µ–Ω.`);
      // –£–¥–∞–ª—è–µ–º –∏–∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, —á—Ç–æ–±—ã –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–ª—Å—è –≤ —Å–ø–∏—Å–∫–µ
      remove(ref(db, 'users/' + userToBan.uid));
    } else if(cmd === '/say'){
      if(args.length < 1){
        sendConsoleMessage('–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /say <—Å–æ–æ–±—â–µ–Ω–∏–µ>');
        return;
      }
      const sayText = args.join(' ');
      // –ü–∏—à–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –∫–æ–Ω—Å–æ–ª–∏ –≤ –æ–±—â–∏–π —á–∞—Ç
      const msgObj = {
        uid: 'console',
        username: '[console]',
        text: sayText,
        timestamp: Date.now(),
        fromConsole: true,
      };
      const newRef = push(ref(db, 'chats/general'));
      msgObj.key = newRef.key;
      await set(newRef, msgObj);
    } else {
      sendConsoleMessage(`–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞: ${cmd}`);
    }
  }

  // --- –ù–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –Ω–∏–∫—É ---
  function findUserByNick(nick){
    for(let [uid, data] of onlineUsers.entries()){
      if(data.username && data.username.toLowerCase() === nick.toLowerCase()){
        return {uid, ...data};
      }
    }
    return null;
  }

  // --- –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –∫–æ–Ω—Å–æ–ª–∏ (–≤–∏–¥–Ω–æ –≤—Å–µ–º) ---
  async function sendConsoleMessage(text){
    const msgObj = {
      uid: 'console',
      username: '[console]',
      text,
      timestamp: Date.now(),
      fromConsole: true,
    };
    const newRef = push(ref(db, 'chats/general'));
    msgObj.key = newRef.key;
    await set(newRef, msgObj);
  }

  // --- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–¥–º–∏–Ω–∞ ---
  function isAdmin(){
    if(!currentUser) return false;
    const nick = currentUser.displayName || currentUser.email.split('@')[0];
    if(ADMINS.has(nick.toLowerCase()) || ADMINS.has(currentUser.email.toLowerCase())) return true;
    return false;
  }

  // --- –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ –ë–î ---
  function updateUsersList(usersData){
    usersListEl.innerHTML = '';
    for(let [uid, data] of Object.entries(usersData || {})){
      onlineUsers.set(uid, data);
      renderUser(uid, data);
    }
  }

  // --- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ prompt ---
  async function loginFlow(){
    while(true){
      let email = prompt('–í–≤–µ–¥–∏—Ç–µ email –¥–ª—è –≤—Ö–æ–¥–∞ –∏–ª–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:');
      if(!email) return alert('–í—Ö–æ–¥ –æ—Ç–º–µ–Ω—ë–Ω');
      let pass = prompt('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å:');
      if(!pass) return alert('–í—Ö–æ–¥ –æ—Ç–º–µ–Ω—ë–Ω');

      try {
        await signInWithEmailAndPassword(auth, email, pass);
        break;
      } catch (e) {
        if(e.code === 'auth/user-not-found'){
          // —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          try {
            await createUserWithEmailAndPassword(auth, email, pass);
            // –æ–±–Ω–æ–≤–∏–º displayName ‚Äî –∑–∞–ø—Ä–æ—Å–∏–º –Ω–∏–∫
            let nick = prompt('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –í–≤–µ–¥–∏—Ç–µ –≤–∞—à –Ω–∏–∫ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è:');
            if(nick && auth.currentUser){
              await updateProfile(auth.currentUser, {displayName: nick});
            }
            break;
          } catch (e2) {
            alert('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: '+e2.message);
          }
        } else {
          alert('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: '+e.message);
        }
      }
    }
  }

  // --- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ users ---
  async function updateCurrentUserOnline(){
    if(!currentUser) return;
    const userRef = ref(db, 'users/' + currentUser.uid);
    await set(userRef, {
      username: currentUser.displayName || currentUser.email.split('@')[0],
      email: currentUser.email,
      online: true,
      lastSeen: Date.now()
    });
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–±—Ä–∞—Ç—å –ø—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏
    onDisconnect(userRef).remove();
  }

  // --- –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ users ---
  function listenUsers(){
    const usersRef = ref(db, 'users');
    onValue(usersRef, snapshot => {
      updateUsersList(snapshot.val());
    });
  }

  // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ UI ---
  sendBtn.onclick = () => sendMessage(textInput.value);
  textInput.addEventListener('keydown', (e) => {
    if(e.key === 'Enter' && !e.shiftKey){
      e.preventDefault();
      sendMessage(textInput.value);
    }
  });

  consoleToggle.onclick = () => {
    if(consolePanel.style.display === 'flex'){
      consolePanel.style.display = 'none';
    } else {
      consolePanel.style.display = 'flex';
      consoleInput.focus();
    }
  };
  consoleSend.onclick = async () => {
    if(!consoleInput.value.trim()) return;
    await handleCommand(consoleInput.value);
    consoleInput.value = '';
  };

  // --- –û—Å–Ω–æ–≤–Ω–æ–π flow ---

  onAuthStateChanged(auth, async user => {
    if(user){
      currentUser = user;
      await updateCurrentUserOnline();

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–¥–º–∏–Ω—Å–∫—É—é –∫–Ω–æ–ø–∫—É, –µ—Å–ª–∏ –∞–¥–º–∏–Ω
      if(isAdmin()){
        consoleToggle.style.display = 'block';
      } else {
        consoleToggle.style.display = 'none';
      }

      // –ó–∞–≥—Ä—É–∑–∏—Ç—å –æ–±—â–∏–π —á–∞—Ç —Å—Ä–∞–∑—É
      openPrivateChat('general', '–û–±—â–∏–π —á–∞—Ç');

      listenUsers();

      updateHeaderChat();
    } else {
      currentUser = null;
      consoleToggle.style.display = 'none';
      // –ó–∞–ø—É—Å–∫–∞–µ–º –ª–æ–≥–∏–Ω
      await loginFlow();
    }
  });

</script>

</body>
</html>
